<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Code Nexus v7.0: å…¨åŠŸèƒ½æ•´åˆç‰ˆ</title>
    <!-- æ ¸å¿ƒåº« -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        :root {
            --bg-color: #050505; --panel-bg: #101010; --accent: #00ff9d; --accent-dim: #005533;
            --danger: #ff3333; --warning: #ffcc00; --text: #e0e0e0; --border: #333;
        }
        body { background: var(--bg-color); color: var(--text); font-family: 'Microsoft JhengHei', sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* === å·¦å´é¢æ¿ (å›ºå®šå¯¬åº¦ï¼ŒFlexå¸ƒå±€) === */
        .panel-left { 
            width: 320px; background: var(--panel-bg); border-right: 1px solid var(--border); 
            padding: 15px; display: flex; flex-direction: column; height: 100vh; box-sizing: border-box;
        }

        .header { text-align: center; color: var(--accent); margin-bottom: 10px; font-weight: bold; letter-spacing: 1px;}

        /* è¦–è¨Šå€å¡Š (å›ºå®šé«˜åº¦ï¼Œé˜²æ­¢è¢«å£“ç¸®) */
        .cam-box { 
            flex: 0 0 200px; /* å›ºå®š 200px */
            background: #000; border: 2px solid var(--accent); border-radius: 6px; 
            overflow: hidden; position: relative; margin-bottom: 10px;
        }
        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }

        .status-box { 
            flex: 0 0 auto; /* ä¾å…§å®¹å¤§å° */
            background: #1a1a1a; padding: 10px; margin-bottom: 10px; 
            border-radius: 6px; border: 1px solid #333; font-size: 0.9em; 
        }
        .metric-row { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .val { font-weight: bold; color: var(--accent); }
        .val.bad { color: var(--danger); }
        .val.warn { color: var(--warning); }

        /* å£“åŠ›æ¢ */
        .stress-bar-bg { height: 6px; background: #333; border-radius: 3px; margin-top: 5px; overflow: hidden; }
        .stress-bar { height: 100%; width: 0%; background: var(--accent); transition: width 0.5s; }

        /* Log è¦–çª— (ä½”æ“šå‰©é¤˜ç©ºé–“ï¼Œè‡ªå‹•æ²å‹•) */
        .log-header { flex: 0 0 auto; font-size: 0.8em; color: #666; margin-bottom: 5px; }
        #log-box { 
            flex: 1 1 auto; /* è‡ªå‹•ä¼¸ç¸® */
            background: #000; padding: 5px; font-family: monospace; font-size: 0.75em; color: #888; 
            overflow-y: auto; border: 1px solid #333; min-height: 100px;
        }
        .log-entry { margin-bottom: 2px; border-bottom: 1px solid #222; padding-bottom: 2px; }

        /* === å³å´é¢æ¿ === */
        .panel-right { flex-grow: 1; padding: 20px; display: flex; flex-direction: column; position: relative; overflow-y: auto; }

        /* åˆ†é æ¨™ç±¤ */
        .nav-tabs { display: flex; gap: 10px; margin-bottom: 15px; flex: 0 0 auto;}
        .tab-btn { background: #222; border: 1px solid #444; color: #aaa; padding: 8px 15px; cursor: pointer; border-radius: 4px; transition: 0.3s; }
        .tab-btn.active { background: var(--accent-dim); color: white; border-color: var(--accent); }
        .tab-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* å…§å®¹å€ */
        .content-area { display: none; flex-direction: column; flex-grow: 1; animation: fadeIn 0.5s; }
        .content-area.active { display: flex; }
        @keyframes fadeIn { from{opacity:0;} to{opacity:1;} }

        /* è¡¨å–®èˆ‡è¼¸å…¥ */
        input, textarea { 
            width: 100%; background: #1a1a1a; border: 1px solid #333; color: white; 
            padding: 10px; border-radius: 4px; box-sizing: border-box; margin-bottom: 10px;
        }
        textarea { resize: vertical; font-family: monospace; }
        .editor-container { flex-grow: 1; display: flex; flex-direction: column; min-height: 300px; border: 1px solid #333; border-radius: 6px; overflow: hidden; }
        #code-editor { flex-grow: 1; background: #0c0c0c; color: #ddd; padding: 15px; border:none; outline:none; font-family: 'Consolas', monospace; font-size:14px; }
        
        .btn-action { background: var(--accent-dim); color: white; border: 1px solid var(--accent); padding: 8px 20px; cursor: pointer; border-radius: 4px; }
        .btn-action:hover { background: var(--accent); color: black; }

        /* åŸ·è¡Œçµæœè¦–çª— */
        #output { height: 100px; background: #000; color: #aaa; padding: 10px; font-family: monospace; border-top: 1px solid #333; overflow-y: auto; white-space: pre-wrap; }

        /* è©•åˆ†è¡¨ */
        .score-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .score-table td, .score-table th { border: 1px solid #333; padding: 8px; text-align: center; }
        .score-table th { background: #222; color: var(--accent); }

        /* èŠå¤©å®¤ */
        #chat-panel { 
            height: 180px; border-top: 1px solid #333; background: #080808; display: flex; flex-direction: column; padding: 10px; margin-top: 10px; flex: 0 0 auto;
        }
        #chat-msgs { flex-grow: 1; overflow-y: auto; margin-bottom: 10px; }
        .msg { padding: 5px 10px; margin-bottom: 5px; border-radius: 4px; font-size: 0.9em; }
        .msg.ai { color: var(--accent); background: #112211; border-left: 2px solid var(--accent); }
        .msg.user { color: #fff; background: #222; align-self: flex-end; }

        /* === è¦†è“‹å±¤ (Overlays) === */
        .overlay { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(5,5,5,0.95); z-index: 1000; display: none; 
            flex-direction: column; justify-content: center; align-items: center; text-align: center; 
        }
        
        /* åå§¿è­¦å‘Š */
        #posture-overlay { 
            background: rgba(255, 204, 0, 0.9); color: black; height: auto; top: 20px; bottom: auto;
            width: auto; left: 50%; transform: translateX(-50%); border-radius: 30px; 
            padding: 15px 30px; font-weight: bold; animation: pulse 1s infinite;
        }
        @keyframes pulse { 0% {transform: translateX(-50%) scale(1);} 50% {transform: translateX(-50%) scale(1.05);} 100% {transform: translateX(-50%) scale(1);} }

        /* æ²»ç™‚æ¨¡å¼ */
        .therapy-box { width: 400px; padding: 30px; border: 2px solid var(--danger); border-radius: 10px; background: #111; }

    </style>
</head>
<body>

    <!-- è¦†è“‹å±¤ï¼šåå§¿ -->
    <div id="posture-overlay" class="overlay">âš ï¸ åµæ¸¬ä¸åˆ°ä½¿ç”¨è€…ï¼Œè«‹åæ­£æˆ–å›åˆ°åº§ä½</div>

    <!-- è¦†è“‹å±¤ï¼šæ²»ç™‚æ¨¡å¼ -->
    <div id="therapy-overlay" class="overlay">
        <div class="therapy-box">
            <h2 style="color:var(--danger)">âš ï¸ ç³»çµ±å¼·åˆ¶ä»‹å…¥</h2>
            <p>åµæ¸¬åˆ°é«˜å£“æˆ–ç„¦æ…®è¡Œç‚ºã€‚ç³»çµ±å†·å»ä¸­ã€‚</p>
            <div id="therapy-text" style="font-size:1.2em; color:#fff; margin:20px 0; min-height:50px;">è¼‰å…¥ä¸­...</div>
            <button class="btn-action" id="btn-resume" onclick="stopTherapy()" style="opacity:0; transition:1s;">æˆ‘å†·éœå¥½äº† â–¶</button>
        </div>
    </div>

    <!-- å·¦å´é¢æ¿ -->
    <div class="panel-left">
        <div class="header">NEXUS v7.0</div>
        
        <div class="cam-box">
            <video id="video" autoplay muted playsinline></video>
        </div>

        <div class="status-box">
            <div class="metric-row"><span>æƒ…ç·’ (Face):</span> <span id="emo-val" class="val">--</span></div>
            <div class="metric-row"><span>è¡Œç‚º (Action):</span> <span id="act-val" class="val" style="color:gray">æ­£å¸¸</span></div>
            <div style="margin-top:5px; font-size:0.8em; color:gray;">ç²¾ç¥è² è¼‰ (Stress)</div>
            <div class="stress-bar-bg"><div id="stress-bar" class="stress-bar"></div></div>
        </div>

        <div class="log-header">ç³»çµ±æ—¥èªŒ (Auto-Sync)</div>
        <div id="log-box"></div>
    </div>

    <!-- å³å´é¢æ¿ -->
    <div class="panel-right">
        
        <!-- éšæ®µå°èˆª -->
        <div class="nav-tabs">
            <button class="tab-btn active" onclick="switchPhase('learning')">1. å­¸ç¿’ (LN)</button>
            <button class="tab-btn" onclick="switchPhase('posing')">2. æ“¬é¡Œ (PP)</button>
            <button class="tab-btn" onclick="switchPhase('peer')">3. äº’è©• (PA)</button>
            <button class="tab-btn" onclick="switchPhase('reflection')">4. åæ€ (RF)</button>
        </div>

        <!-- 1. å­¸ç¿’éšæ®µ -->
        <div id="phase-learning" class="content-area active">
            <div style="background:#151515; padding:20px; border-radius:8px; border-left:4px solid var(--accent);">
                <h2>ğŸ“ å–®å…ƒï¼šPython æ¢ä»¶åˆ¤æ–· (if-else)</h2>
                <p>è«‹é–±è®€ä»¥ä¸‹ç¯„ä¾‹ï¼Œç†è§£ç¨‹å¼é‚è¼¯ã€‚</p>
                <pre style="background:#222; padding:10px; color:#aaa; font-family:monospace;">
age = 20
if age >= 18:
    print("æˆå¹´")
else:
    print("æœªæˆå¹´")
                </pre>
                <p>ä»»å‹™ï¼šè«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•ç¢ºèªé–±è®€å®Œç•¢ï¼Œä¸¦æº–å‚™é€²å…¥ã€Œæ“¬é¡Œã€éšæ®µã€‚</p>
                <button class="btn-action" onclick="finishLearning()">âœ… æˆ‘å·²é–±è®€å®Œç•¢</button>
            </div>
        </div>

        <!-- 2. æ“¬é¡Œéšæ®µ -->
        <div id="phase-posing" class="content-area">
            <div style="display:flex; gap:20px; height:100%;">
                <!-- å·¦åŠéƒ¨ï¼šè¡¨å–® -->
                <div style="flex:1; display:flex; flex-direction:column;">
                    <label>é¡Œç›®åç¨±</label>
                    <input id="pp-title" placeholder="ä¾‹å¦‚ï¼šåˆ¤æ–·æˆç¸¾åŠæ ¼">
                    <label>é¡Œç›®æ•˜è¿°</label>
                    <textarea id="pp-desc" style="height:80px;" placeholder="è«‹æè¿°é¡Œç›®è¦æ±‚..."></textarea>
                    <label>è¼¸å…¥/è¼¸å‡ºç¯„ä¾‹</label>
                    <input id="pp-io" placeholder="è¼¸å…¥: 60, è¼¸å‡º: åŠæ ¼">
                </div>
                <!-- å³åŠéƒ¨ï¼šç¨‹å¼ç¢¼ -->
                <div style="flex:1.2; display:flex; flex-direction:column;">
                    <label>æ¨™æº–è§£ç­”ç¨‹å¼ç¢¼ (å¯åŸ·è¡Œæ¸¬è©¦)</label>
                    <div class="editor-container">
                        <textarea id="code-editor" placeholder="# è«‹åœ¨æ­¤æ’°å¯«è§£ç­”..."></textarea>
                        <div id="output">ç­‰å¾…åŸ·è¡Œ...</div>
                    </div>
                    <div style="margin-top:10px; display:flex; justify-content:space-between;">
                        <button class="btn-action" style="background:#444; border-color:#666;" onclick="runPython()">â–¶ åŸ·è¡Œä»£ç¢¼</button>
                        <button class="btn-action" onclick="submitProblem()">ğŸ“¤ æäº¤ä¸¦é€²å…¥äº’è©•</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 3. äº’è©•éšæ®µ -->
        <div id="phase-peer" class="content-area">
            <h3>ğŸ¤– AI åŒå„•è©•åˆ†çµæœ</h3>
            <p>AI åŒå­¸å·²ç¶“é‡å°æ‚¨æäº¤çš„é¡Œç›®é€²è¡Œè©•æ¸¬ï¼Œçµæœå¦‚ä¸‹ï¼š</p>
            <div id="peer-loading" style="color:var(--accent);">è©•åˆ†è¨ˆç®—ä¸­... <span id="gas-status"></span></div>
            
            <div id="peer-result" style="display:none; animation:fadeIn 1s;">
                <table class="score-table">
                    <tr><th>è©•åˆ†å‘åº¦</th><th>å¾—åˆ† (1-4)</th><th>AI å…·é«”å»ºè­°</th></tr>
                    <tr><td>é¡Œç›®æ­£ç¢ºæ€§</td><td id="s1">-</td><td rowspan="5" id="s-comment" style="text-align:left; vertical-align:top; color:#ddd;"></td></tr>
                    <tr><td>é¡Œç›®è¤‡é›œæ€§</td><td id="s2">-</td></tr>
                    <tr><td>é¡Œç›®å¯¦ç”¨æ€§</td><td id="s3">-</td></tr>
                    <tr><td>ç¨‹å¼æ­£ç¢ºæ€§</td><td id="s4">-</td></tr>
                    <tr><td>ç¨‹å¼å¯è®€æ€§</td><td id="s5">-</td></tr>
                </table>
                <br>
                <button class="btn-action" onclick="switchPhase('reflection')">å‰å¾€åæ€ä¿®æ­£ â¡</button>
            </div>
        </div>

        <!-- 4. åæ€éšæ®µ -->
        <div id="phase-reflection" class="content-area">
            <h3>ğŸ¤” å­¸ç¿’åæ€</h3>
            <p>æ ¹æ“šåŒå„•çš„å›é¥‹ï¼Œæ‚¨è¦ºå¾—é¡Œç›®æœ‰å“ªäº›åœ°æ–¹å¯ä»¥æ”¹é€²ï¼Ÿ</p>
            <textarea id="rf-content" style="height:150px;" placeholder="ä¾‹å¦‚ï¼šæˆ‘ç™¼ç¾æˆ‘çš„è®Šæ•¸å‘½åå¯ä»¥æ›´æ¸…æ¥š..."></textarea>
            <button class="btn-action" onclick="submitReflection()">æäº¤åæ€ä¸¦çµæŸ</button>
        </div>

        <!-- åº•éƒ¨ï¼šèŠå¤©å®¤ -->
        <div id="chat-panel">
            <div id="chat-msgs"></div>
            <div style="display:flex; gap:10px;">
                <input id="chat-input" placeholder="è¼¸å…¥è¨Šæ¯..." onkeypress="if(event.key==='Enter') sendChat()">
                <button class="btn-action" onclick="sendChat()">ç™¼é€</button>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // ğŸ”‘ è¨­å®šå€ (è«‹å‹™å¿…å¡«å¯«)
        // ==========================================
        const API_KEY = "AIzaSyBkm9yIrb-DKXGUgfrFa5wCJKcm4TqQ1Tw"; 
        const GAS_URL = "https://script.google.com/macros/s/AKfycbz9RZTbGWGXBTCez5KiXt478WKgNt08pBFMH9CM4FjvIi6mlLEFzksjCG-dB5Zc4imA6A/exec"; 
        // ==========================================

        // ç³»çµ±è®Šæ•¸
        let pyodide = null;
        let isFaceLoaded = false;
        let isTherapy = false;
        let currentPhase = 'learning';
        
        // ç›£æ§è®Šæ•¸
        let stressScore = 0;
        let mouseDist = 0, lastMouseX = 0, lastMouseY = 0;
        let backspaceCount = 0;
        let behaviorPenalty = 0;
        let faceMissingCount = 0;
        let hasFace = false;

        // åˆå§‹åŒ–
        async function init() {
            log('SYS', 'ç³»çµ±åˆå§‹åŒ–ä¸­...');
            
            // 1. è¼‰å…¥ FaceAPI
            const MODEL_URL = 'https://justadudewhohacks.github.io/face-api.js/models';
            try {
                await Promise.all([
                    faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                    faceapi.nets.faceExpressionNet.loadFromUri(MODEL_URL)
                ]);
                isFaceLoaded = true;
                log('SYS', 'è¦–è¦ºæ¨¡çµ„å·²å°±ç·’');
            } catch(e) { log('ERR', 'è¦–è¦ºæ¨¡çµ„è¼‰å…¥å¤±æ•—'); }

            // 2. å•Ÿå‹• Webcam
            const video = document.getElementById('video');
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
                video.srcObject = stream;
                video.addEventListener('play', () => {
                    setInterval(monitorLoop, 1000); // 1ç§’ä¸€æ¬¡ç›£æ§
                });
            } catch(e) { log('ERR', 'ç„¡æ³•å­˜å–æ”å½±æ©Ÿ'); }

            // 3. è¼‰å…¥ Pyodide
            try {
                pyodide = await loadPyodide();
                log('SYS', 'Python æ ¸å¿ƒå·²å°±ç·’');
            } catch(e) { log('ERR', 'Python è¼‰å…¥å¤±æ•—'); }

            // 4. è¼¸å…¥ç›£è½
            document.addEventListener('mousemove', (e) => {
                if(lastMouseX === 0) { lastMouseX = e.clientX; lastMouseY = e.clientY; return; }
                const dist = Math.sqrt(Math.pow(e.clientX - lastMouseX, 2) + Math.pow(e.clientY - lastMouseY, 2));
                mouseDist += dist; lastMouseX = e.clientX; lastMouseY = e.clientY;
            });
            document.addEventListener('keydown', (e) => {
                if(e.key === 'Backspace') backspaceCount++;
            });

            addMsg('ai', 'ç³»çµ±ï¼šæ­¡è¿ã€‚ç›®å‰è™•æ–¼ã€Œå­¸ç¿’éšæ®µ (LN)ã€ï¼Œè«‹é–±è®€æ•™æã€‚');
        }
        init();

        // ==========================================
        // ğŸ‘ï¸ ç›£æ§æ ¸å¿ƒ (Monitor Loop)
        // ==========================================
        async function monitorLoop() {
            if(isTherapy) return;

            // 1. äººè‡‰åµæ¸¬
            const video = document.getElementById('video');
            const posOverlay = document.getElementById('posture-overlay');
            let emoText = "--";

            if(isFaceLoaded) {
                const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions()).withFaceExpressions();
                
                if(detections.length > 0) {
                    hasFace = true; faceMissingCount = 0;
                    posOverlay.style.display = 'none'; // éš±è—è­¦å‘Š
                    
                    const ex = detections[0].expressions;
                    const top = Object.entries(ex).sort((a,b) => b[1]-a[1])[0][0];
                    emoText = top;
                    
                    // è² é¢æƒ…ç·’åŠ å£“
                    if(['sad', 'angry', 'fearful'].includes(top)) behaviorPenalty += 2;
                } else {
                    if(hasFace) { // æ›¾åµæ¸¬åˆ°äººï¼Œç¾åœ¨ä¸è¦‹äº†
                        faceMissingCount++;
                        if(faceMissingCount > 5) posOverlay.style.display = 'block'; // 5ç§’ä¸è¦‹è­¦å‘Š
                    }
                }
                document.getElementById('emo-val').innerText = emoText;
            }

            // 2. è¡Œç‚ºåµæ¸¬ (éå‹•/ç„¦æ…®)
            let actText = "æ­£å¸¸";
            let actClass = "val";
            let deltaPenalty = 0;

            if(mouseDist > 3000) { actText = "æ»‘é¼ éå‹•"; actClass = "val warn"; deltaPenalty += 5; log('ACT', 'Mouse Jitter'); }
            if(backspaceCount > 10) { actText = "éµç›¤ç„¦æ…®"; actClass = "val warn"; deltaPenalty += 8; log('ACT', 'Keyboard Anxiety'); }
            
            // é‡ç½®è¨ˆæ•¸å™¨
            mouseDist = 0; backspaceCount = 0;
            const actEl = document.getElementById('act-val');
            actEl.innerText = actText; actEl.className = actClass;

            // 3. å£“åŠ›è¨ˆç®—
            if(deltaPenalty > 0) behaviorPenalty += deltaPenalty;
            else behaviorPenalty = Math.max(0, behaviorPenalty - 2); // å†·å»

            stressScore = Math.min(100, behaviorPenalty);
            const bar = document.getElementById('stress-bar');
            bar.style.width = stressScore + "%";
            
            if(stressScore < 40) bar.style.background = "#00ff9d";
            else if(stressScore < 85) bar.style.background = "orange";
            else bar.style.background = "#ff3333";

            // è§¸ç™¼æ²»ç™‚
            if(stressScore > 90) startTherapy();
        }

        // ==========================================
        // ğŸ§ª åŠŸèƒ½å‡½æ•¸ï¼šPython åŸ·è¡Œ
        // ==========================================
        async function runPython() {
            const code = document.getElementById('code-editor').value;
            const out = document.getElementById('output');
            out.innerText = ">>> Executing...";
            if(!pyodide) return;
            
            try {
                pyodide.setStdout({ batched: (m) => out.innerText += m + "\n" });
                await pyodide.runPythonAsync(code);
            } catch(e) {
                out.innerText = "Error: " + e;
            }
        }

        // ==========================================
        // ğŸ“ éšæ®µæµç¨‹æ§åˆ¶
        // ==========================================
        function switchPhase(phase) {
            currentPhase = phase;
            // UI Update
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.content-area').forEach(c => c.classList.remove('active'));
            
            const idx = {'learning':0, 'posing':1, 'peer':2, 'reflection':3}[phase];
            document.querySelectorAll('.tab-btn')[idx].classList.add('active');
            document.querySelectorAll('.content-area')[idx].classList.add('active');
            
            log('NAV', `åˆ‡æ›è‡³éšæ®µ: ${phase}`);
        }

        function finishLearning() {
            log('LN', 'å­¸ç¿’éšæ®µå®Œæˆ');
            sendToSheet('LOG', { action: 'LN_DONE', detail: 'User finished reading' });
            switchPhase('posing');
        }

        async function submitProblem() {
            const title = document.getElementById('pp-title').value;
            const desc = document.getElementById('pp-desc').value;
            const code = document.getElementById('code-editor').value;

            if(!title || !code) { alert("è«‹å¡«å¯«å®Œæ•´é¡Œç›®èˆ‡ç¨‹å¼ç¢¼"); return; }

            // 1. è¨˜éŒ„ä¸¦ä¸Šå‚³
            log('PP', `æäº¤é¡Œç›®: ${title}`);
            sendToSheet('PROBLEM', { title, desc, code });
            
            // 2. åˆ‡æ›ä¸¦é–‹å§‹ AI è©•åˆ†
            switchPhase('peer');
            document.getElementById('peer-loading').style.display = 'block';
            document.getElementById('peer-result').style.display = 'none';

            // 3. å‘¼å« Gemini
            const prompt = `
            è«‹æ‰®æ¼”ç¨‹å¼è¨­è¨ˆåŒå­¸ã€‚é‡å°æˆ‘å‡ºçš„é¡Œç›®é€²è¡Œäº’è©•ã€‚
            é¡Œç›®ï¼š${title}
            æ•˜è¿°ï¼š${desc}
            è§£ç­”ä»£ç¢¼ï¼š${code}
            
            è«‹å›å‚³ JSON: { "scores": [åˆ†1, åˆ†2, åˆ†3, åˆ†4, åˆ†5], "comment": "ç¹é«”ä¸­æ–‡è©•èª" }
            åˆ†æ•¸ 1-4 åˆ†ã€‚å‘åº¦ï¼šé¡Œç›®æ­£ç¢ºæ€§ã€è¤‡é›œæ€§ã€å¯¦ç”¨æ€§ã€ç¨‹å¼æ­£ç¢ºæ€§ã€å¯è®€æ€§ã€‚
            `;

            try {
                const res = await callGemini(prompt);
                const json = JSON.parse(extractJSON(res));
                
                // é¡¯ç¤ºçµæœ
                for(let i=0; i<5; i++) document.getElementById(`s${i+1}`).innerText = json.scores[i];
                document.getElementById('s-comment').innerText = json.comment;
                
                document.getElementById('peer-loading').style.display = 'none';
                document.getElementById('peer-result').style.display = 'block';

                // ä¸Šå‚³è©•åˆ†çµæœ
                log('PA', 'æ”¶åˆ° AI è©•åˆ†');
                sendToSheet('ASSESSMENT', { scores: json.scores, comment: json.comment });

            } catch(e) {
                console.error(e);
                alert("AI é€£ç·šå¤±æ•—");
            }
        }

        async function submitReflection() {
            const content = document.getElementById('rf-content').value;
            if(!content) return;
            
            log('RF', 'æäº¤åæ€');
            await sendToSheet('REFLECTION', { content });
            alert("æœ¬å–®å…ƒå­¸ç¿’å®Œæˆï¼è³‡æ–™å·²ä¿å­˜ã€‚");
            // å¯ä»¥åœ¨æ­¤é‡ç½®ç³»çµ±æˆ–è·³è½‰
        }

        // ==========================================
        // ğŸ¥ æ²»ç™‚æ¨¡å¼
        // ==========================================
        async function startTherapy() {
            if(isTherapy) return;
            isTherapy = true;
            document.getElementById('therapy-overlay').style.display = 'flex';
            
            const prompt = "ä½¿ç”¨è€…ç¾åœ¨å£“åŠ›éå¤§(Stress > 90)ï¼Œè«‹è¬›ä¸€å€‹ç°¡çŸ­çš„å·¥ç¨‹å¸«å†·ç¬‘è©±å®‰æ’«ä»–ã€‚ç¹é«”ä¸­æ–‡ã€‚";
            const reply = await callGemini(prompt);
            
            const txt = document.getElementById('therapy-text');
            txt.innerText = "";
            let i = 0;
            const timer = setInterval(() => {
                txt.innerText += reply.charAt(i); i++;
                if(i >= reply.length) {
                    clearInterval(timer);
                    document.getElementById('btn-resume').style.opacity = '1';
                }
            }, 50);
            
            log('SYS', 'å•Ÿå‹•æ²»ç™‚æ¨¡å¼');
        }

        function stopTherapy() {
            document.getElementById('therapy-overlay').style.display = 'none';
            document.getElementById('btn-resume').style.opacity = '0';
            behaviorPenalty = 30; // é™å£“
            isTherapy = false;
            log('SYS', 'çµæŸæ²»ç™‚æ¨¡å¼');
        }

        // ==========================================
        // ğŸ“¡ æ•¸æ“šå‚³è¼¸ (Google Sheet)
        // ==========================================
        async function sendToSheet(type, data) {
            if(!GAS_URL.startsWith("http")) return; // é˜²æ­¢æœªè¨­å®šå ±éŒ¯

            const payload = { type, ...data };
            try {
                await fetch(GAS_URL, {
                    method: 'POST',
                    mode: 'no-cors', // é‡è¦ï¼šé¿å… CORS éŒ¯èª¤
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                // Note: no-cors æ¨¡å¼ç„¡æ³•è®€å–å›å‚³å€¼ï¼Œä½†ç™¼é€é€šå¸¸æœƒæˆåŠŸ
                if(type !== 'LOG') document.getElementById('gas-status').innerText = "(å·²å‚™ä»½è‡³é›²ç«¯)";
            } catch(e) { console.error("Upload failed", e); }
        }

        // ==========================================
        // ğŸ¤– AI èˆ‡ Log å·¥å…·
        // ==========================================
        async function callGemini(text) {
            if(!API_KEY || API_KEY.includes("è«‹å¡«å…¥")) { alert("è«‹è¼¸å…¥ API Key"); return "{}"; }
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${API_KEY}`;
            const res = await fetch(url, {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ contents: [{ parts: [{ text }] }] })
            });
            const data = await res.json();
            return data.candidates[0].content.parts[0].text;
        }

        async function sendChat() {
            const input = document.getElementById('chat-input');
            const val = input.value;
            if(!val) return;
            
            addMsg('user', val);
            input.value = "";
            log('EX', `Chat: ${val}`);

            const prompt = `ä½ æ˜¯ç¨‹å¼å°å¸«ã€‚å­¸ç”Ÿç›®å‰åœ¨${currentPhase}éšæ®µã€‚å­¸ç”Ÿèªªï¼š${val}ã€‚è«‹ç°¡çŸ­å›æ‡‰ã€‚`;
            const reply = await callGemini(prompt);
            addMsg('ai', reply);
        }

        function addMsg(role, text) {
            const div = document.createElement('div');
            div.className = `msg ${role}`;
            div.innerText = text;
            const box = document.getElementById('chat-msgs');
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        function log(type, detail) {
            // 1. æ›´æ–° UI (è‡ªå‹•æ²å‹•)
            const box = document.getElementById('log-box');
            const time = new Date().toLocaleTimeString();
            const div = document.createElement('div');
            div.className = 'log-entry';
            div.innerHTML = `<span style="color:#444">[${time}]</span> <span style="color:var(--accent)">${type}</span>: ${detail}`;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight; // è‡ªå‹•æ²å‹•

            // 2. å‚³é€è‡³ Google Sheet
            // ç‚ºäº†ä¸æ´—ç‰ˆï¼ŒLOG å¯ä»¥é¸æ“‡æ€§ä¸Šå‚³ï¼Œæˆ–ç´¯ç©ä¸Šå‚³ã€‚é€™è£¡ç¤ºç¯„å³æ™‚ä¸Šå‚³ã€‚
            if(type !== 'ACT') sendToSheet('LOG', { action: type, detail: detail });
        }

        function extractJSON(str) {
            const s = str.indexOf('{'); const e = str.lastIndexOf('}');
            return (s!==-1 && e!==-1) ? str.substring(s, e+1) : "{}";
        }
    </script>
</body>
</html>
