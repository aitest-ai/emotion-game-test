<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Code Nexus v11.0: ç©©å®šä½ˆå±€èˆ‡è¡Œç‚ºæ„ŸçŸ¥ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        :root {
            --bg-color: #050505; --panel-bg: #101010; --accent: #00ff9d; --accent-dim: #005533;
            --danger: #ff3333; --warning: #ffcc00; --text: #e0e0e0; --border: #333;
        }
        
        /* å…¨å±€è¨­å®šï¼šç¦æ­¢ Body æ²å‹•ï¼Œå®Œå…¨äº¤ç”±å…§éƒ¨å€å¡Šè™•ç† */
        body { background: var(--bg-color); color: var(--text); font-family: 'Microsoft JhengHei', sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* === å·¦å´é¢æ¿ === */
        .panel-left { 
            width: 320px; min-width: 320px; 
            background: var(--panel-bg); border-right: 1px solid var(--border); 
            padding: 15px; display: flex; flex-direction: column; height: 100vh; box-sizing: border-box; 
        }

        .cam-box { flex: 0 0 200px; background: #000; border: 2px solid var(--accent); border-radius: 6px; overflow: hidden; position: relative; margin-bottom: 10px; }
        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }

        .status-box { flex: 0 0 auto; background: #1a1a1a; padding: 10px; margin-bottom: 10px; border-radius: 6px; border: 1px solid #333; font-size: 0.9em; }
        .metric-row { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .val { font-weight: bold; color: var(--accent); }
        .stress-bar-bg { height: 6px; background: #333; border-radius: 3px; margin-top: 5px; overflow: hidden; }
        .stress-bar { height: 100%; width: 0%; background: var(--accent); transition: width 0.5s; }

        .log-header { flex: 0 0 auto; font-size: 0.8em; color: #666; margin-bottom: 5px; }
        #log-box { 
            flex: 1 1 auto; /* è‡ªå‹•å¡«æ»¿å‰©é¤˜é«˜åº¦ */
            background: #000; padding: 5px; font-family: monospace; font-size: 0.75em; color: #888; 
            overflow-y: auto; /* å…§éƒ¨æ²å‹• */
            border: 1px solid #333; 
        }
        .log-entry { margin-bottom: 2px; border-bottom: 1px solid #222; padding-bottom: 2px; }

        /* === å³å´é¢æ¿ (é—œéµä¿®æ”¹ï¼šFlex Column ä½ˆå±€) === */
        .panel-right { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            height: 100vh; /* ç¢ºä¿é«˜åº¦æ’æ»¿ */
            overflow: hidden; /* é˜²æ­¢æ•´å€‹å³å´å‡ºç¾æ²è»¸ */
            padding: 20px; 
            box-sizing: border-box;
        }

        .nav-tabs { display: flex; gap: 10px; margin-bottom: 15px; flex: 0 0 auto; }
        .tab-btn { background: #222; border: 1px solid #444; color: #aaa; padding: 8px 15px; cursor: pointer; border-radius: 4px; transition: 0.3s; }
        .tab-btn.active { background: var(--accent-dim); color: white; border-color: var(--accent); }

        /* ä¸»è¦å…§å®¹å€ (è‡ªå‹•ä¼¸ç¸®ï¼Œå…§éƒ¨æ²å‹•) */
        .content-area { 
            display: none; 
            flex-direction: column; 
            flex: 1; /* é—œéµï¼šä½”æ“šé™¤äº† Tab å’Œ Chat ä¹‹å¤–çš„æ‰€æœ‰ç©ºé–“ */
            overflow-y: auto; /* å…§å®¹å¤šæ™‚è‡ªå·±æ²å‹•ï¼Œä¸æ¨æ“ åˆ¥äºº */
            padding-right: 5px; 
            margin-bottom: 10px; /* èˆ‡èŠå¤©å®¤çš„é–“è· */
        }
        .content-area.active { display: flex; }

        /* è¼¸å…¥å…ƒä»¶ */
        input, textarea, select { width: 100%; background: #1a1a1a; border: 1px solid #333; color: white; padding: 10px; border-radius: 4px; box-sizing: border-box; margin-bottom: 10px; }
        .editor-container { flex: 1; min-height: 200px; display: flex; flex-direction: column; border: 1px solid #333; border-radius: 6px; overflow: hidden; margin-bottom: 10px; }
        #code-editor { flex: 1; background: #0c0c0c; color: #ddd; padding: 15px; border:none; outline:none; font-family: 'Consolas', monospace; resize:none; }
        .btn-action { background: var(--accent-dim); color: white; border: 1px solid var(--accent); padding: 8px 20px; cursor: pointer; border-radius: 4px; }
        .btn-action:hover { background: var(--accent); color: black; }

        /* AI å›é¥‹è¡¨æ ¼ */
        .score-table { width: 100%; border-collapse: collapse; margin-top: 10px; table-layout: fixed; }
        .score-table td, .score-table th { border: 1px solid #333; padding: 8px; text-align: center; vertical-align: middle; }
        .score-table th { background: #222; color: var(--accent); width: 20%; }
        .score-table td.comment-cell { text-align: left; vertical-align: top; white-space: pre-wrap; height: 80px;}

        /* === èŠå¤©å®¤ (å›ºå®šé«˜åº¦ï¼Œå…§éƒ¨æ²å‹•) === */
        #chat-panel { 
            flex: 0 0 200px; /* å›ºå®šé«˜åº¦ 200px */
            border-top: 1px solid #333; 
            background: #080808; 
            display: flex; 
            flex-direction: column; 
            padding: 10px; 
        }
        #chat-msgs { 
            flex: 1; /* ä½”æ»¿ panel å…§å‰©é¤˜ç©ºé–“ */
            overflow-y: auto; /* è¨Šæ¯å¤šæ™‚å…§éƒ¨æ²å‹• */
            margin-bottom: 10px; 
            min-height: 0; /* Flexbox å¿…å‚™ï¼Œé˜²æ­¢å…§å®¹æº¢å‡º */
        }
        .msg { padding: 8px 12px; margin-bottom: 5px; border-radius: 4px; font-size: 0.9em; max-width: 90%; word-wrap: break-word; }
        .msg.ai { color: var(--accent); background: #112211; border-left: 3px solid var(--accent); align-self: flex-start; }
        .msg.user { color: #fff; background: #004455; align-self: flex-end; }
        
        /* æ‰“å­—æ©Ÿå…‰æ¨™ */
        .typing-cursor::after { content: 'â–‹'; animation: blink 1s infinite; color: var(--accent); }
        @keyframes blink { 0%, 100% {opacity: 1;} 50% {opacity: 0;} }

        /* è¦†è“‹å±¤ */
        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(5,5,5,0.95); z-index: 1000; display: none; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        #face-lock-overlay { backdrop-filter: blur(10px); background: rgba(0,0,0,0.85); z-index: 3000; }
        .lock-icon { font-size: 50px; margin-bottom: 20px; animation: pulse 1s infinite; }
        @keyframes pulse { 0% {transform: scale(1);} 50% {transform: scale(1.1);} 100% {transform: scale(1);} }
        .login-box { width: 350px; padding: 40px; border: 1px solid var(--accent); border-radius: 10px; background: #111; }

    </style>
</head>
<body>

    <!-- è¦†è“‹å±¤ -->
    <div id="login-overlay" class="overlay" style="display:flex;">
        <div class="login-box">
            <h2 style="color:var(--accent);">CODE NEXUS v11.0</h2>
            <p style="color:#888;">è«‹è¼¸å…¥å­¸è™Ÿå•Ÿå‹•ç³»çµ±</p>
            <input type="text" id="student-id-input" placeholder="å­¸è™Ÿ" style="text-align:center;">
            <button class="btn-action" onclick="loginSystem()" style="width:100%;">å•Ÿå‹•ç³»çµ± â–¶</button>
        </div>
    </div>

    <div id="face-lock-overlay" class="overlay">
        <div class="lock-icon">âš ï¸</div>
        <h2 style="color:var(--warning);">ç³»çµ±æš«åœ</h2>
        <p style="color:#ccc;">åµæ¸¬ä¸åˆ°è‡‰éƒ¨ï¼Œè«‹å›åˆ°åº§ä½ã€‚</p>
    </div>

    <div id="therapy-overlay" class="overlay">
        <h2 style="color:var(--danger)">âš ï¸ å£“åŠ›éè¼‰</h2>
        <p>åµæ¸¬åˆ°é«˜åº¦ç„¦æ…®è¡Œç‚º (éå‹•/äº‚æŒ‰)ã€‚è«‹ä¼‘æ¯ã€‚</p>
        <div id="therapy-text" style="color:#fff; margin:20px 0; font-size:1.2em;">è¼‰å…¥ä¸­...</div>
        <button class="btn-action" id="btn-resume" onclick="stopTherapy()" style="opacity:0;">ç¹¼çºŒä»»å‹™</button>
    </div>

    <!-- å·¦å´é¢æ¿ -->
    <div class="panel-left">
        <div class="header">NEXUS v11.0</div>
        <div id="display-student-id" style="text-align:center; color:#888; margin-bottom:10px;">æœªç™»å…¥</div>
        
        <div class="cam-box"><video id="video" autoplay muted playsinline></video></div>
        
        <div class="status-box">
            <div class="metric-row"><span>æƒ…ç·’:</span> <span id="emo-val" class="val">--</span></div>
            <div class="metric-row"><span>ç‹€æ…‹:</span> <span id="act-val" class="val" style="color:gray">æ­£å¸¸</span></div>
            <div style="margin-top:5px; font-size:0.8em; color:gray;">å­¸ç¿’å£“åŠ› (Stress Level)</div>
            <div class="stress-bar-bg"><div id="stress-bar" class="stress-bar"></div></div>
        </div>
        
        <div class="log-header">ç³»çµ±æ—¥èªŒ</div>
        <div id="log-box"></div>
    </div>

    <!-- å³å´é¢æ¿ -->
    <div class="panel-right">
        <div class="nav-tabs">
            <button class="tab-btn active" onclick="switchPhase('learning')">1. å­¸ç¿’ (LN)</button>
            <button class="tab-btn" onclick="switchPhase('posing')">2. æ“¬é¡Œ (PP)</button>
            <button class="tab-btn" onclick="switchPhase('human-review')">3. è©•åŒå„• (HR)</button>
            <button class="tab-btn" onclick="switchPhase('ai-review')">4. AI è©•æˆ‘ (PA)</button>
            <button class="tab-btn" onclick="switchPhase('reflection')">5. åæ€ (RF)</button>
        </div>

        <!-- 1. å­¸ç¿’ -->
        <div id="phase-learning" class="content-area active">
            <div style="background:#151515; padding:20px; border-radius:8px; border-left:4px solid var(--accent);">
                <h2>ğŸ“ å–®å…ƒï¼šPython æ¢ä»¶åˆ¤æ–·</h2>
                <p>è«‹ä»”ç´°é–±è®€ä»¥ä¸‹æ•™æï¼š</p>
                <pre style="background:#222; padding:10px; color:#aaa;">
score = 80
if score >= 60:
    print("Pass")
else:
    print("Fail")
                </pre>
                <p>é€™æ®µç¨‹å¼ç¢¼å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ if-else çµæ§‹ä¾†åˆ¤æ–·åˆ†æ•¸æ˜¯å¦åŠæ ¼ã€‚</p>
                <button class="btn-action" onclick="finishLearning()">âœ… é–±è®€å®Œç•¢</button>
            </div>
        </div>

        <!-- 2. æ“¬é¡Œ -->
        <div id="phase-posing" class="content-area">
            <label>é¡Œç›®åç¨±</label><input id="pp-title" placeholder="ä¾‹å¦‚ï¼šåˆ¤æ–·å¥‡å¶æ•¸">
            <label>é¡Œç›®æ•˜è¿°</label><textarea id="pp-desc" style="height:80px;"></textarea>
            <label>åƒè€ƒè§£ç­”ä»£ç¢¼</label>
            <div class="editor-container">
                <textarea id="code-editor" placeholder="# è«‹åœ¨æ­¤è¼¸å…¥è§£ç­”..."></textarea>
            </div>
            <div style="display:flex; justify-content:space-between; margin-top:10px;">
                 <button class="btn-action" style="background:#444;" onclick="runPython()">â–¶ æ¸¬è©¦ä»£ç¢¼</button>
                 <button class="btn-action" onclick="finishPosing()">æš«å­˜ä¸¦ä¸‹ä¸€æ­¥ â¡</button>
            </div>
        </div>

        <!-- 3. è©•åŒå„• -->
        <div id="phase-human-review" class="content-area">
            <h3>ğŸ‘¥ è©•åˆ†å…¶ä»–åŒå­¸çš„é¡Œç›®</h3>
            <button class="btn-action" onclick="loadPeerProblem()" style="background:#444; margin-bottom:15px;">ğŸ“¥ è¼‰å…¥åŒå„•æŒ‘æˆ°</button>
            
            <div id="human-review-area" style="display:none; border:1px solid #333; padding:15px; border-radius:6px;">
                <h4 id="hr-title" style="color:var(--accent); margin-top:0;"></h4>
                <p id="hr-desc" style="color:#aaa; background:#111; padding:10px; border-radius:4px;"></p>
                <pre id="hr-code" style="background:#222; padding:10px; overflow-x:auto;"></pre>
                
                <hr style="border-color:#333; margin:15px 0;">
                
                <table class="score-table">
                    <tr><th>æ­£ç¢º</th><th>è¤‡é›œ</th><th>å¯¦ç”¨</th><th>ä»£ç¢¼</th><th>å¯è®€</th></tr>
                    <tr>
                        <td><input type="number" id="hr-s1" min="1" max="5" value="3"></td>
                        <td><input type="number" id="hr-s2" min="1" max="5" value="3"></td>
                        <td><input type="number" id="hr-s3" min="1" max="5" value="3"></td>
                        <td><input type="number" id="hr-s4" min="1" max="5" value="3"></td>
                        <td><input type="number" id="hr-s5" min="1" max="5" value="3"></td>
                    </tr>
                </table>
                <textarea id="hr-comment" style="margin-top:10px; height:60px;" placeholder="çµ¦åŒå­¸çš„è©•èª..."></textarea>
                <button class="btn-action" onclick="submitHumanReview()">ğŸ“¤ é€å‡ºè©•åˆ†</button>
            </div>
        </div>

        <!-- 4. AI è©•æˆ‘ -->
        <div id="phase-ai-review" class="content-area">
            <h3>ğŸ¤– AI è©•åˆ†ä½ çš„é¡Œç›®</h3>
            <button class="btn-action" onclick="triggerAIReview()">å•Ÿå‹• AI è©•åˆ†</button>
            
            <div id="ai-result" style="display:none; margin-top:15px;">
                <table class="score-table">
                    <tr><th>å‘åº¦</th><th>å¾—åˆ†</th><th>AI è©•èª</th></tr>
                    <tr><td>é¡Œç›®æ­£ç¢º</td><td id="ai-s1">-</td><td rowspan="5" id="ai-comment-cell" class="comment-cell"></td></tr>
                    <tr><td>è¤‡é›œåº¦</td><td id="ai-s2">-</td></tr>
                    <tr><td>å¯¦ç”¨æ€§</td><td id="ai-s3">-</td></tr>
                    <tr><td>ä»£ç¢¼æ­£ç¢º</td><td id="ai-s4">-</td></tr>
                    <tr><td>å¯è®€æ€§</td><td id="ai-s5">-</td></tr>
                </table>
                <br>
                <button class="btn-action" onclick="switchPhase('reflection')">å‰å¾€åæ€ â¡</button>
            </div>
        </div>

        <!-- 5. åæ€ -->
        <div id="phase-reflection" class="content-area">
            <h3>ğŸ¤” å­¸ç¿’åæ€</h3>
            <p>æ ¹æ“š AI èˆ‡åŒå„•çš„å›é¥‹ï¼Œä½ å­¸åˆ°äº†ä»€éº¼ï¼Ÿ</p>
            <textarea id="rf-content" style="height:150px;"></textarea>
            <button class="btn-action" onclick="submitAll()">âœ… æäº¤æ‰€æœ‰æˆæœ</button>
        </div>

        <!-- èŠå¤©å®¤ (å›ºå®šåº•éƒ¨) -->
        <div id="chat-panel">
            <div id="chat-msgs"></div>
            <div style="display:flex; gap:10px;">
                <input id="chat-input" placeholder="è¼¸å…¥è¨Šæ¯..." onkeypress="if(event.key==='Enter') sendChat()">
                <button class="btn-action" onclick="sendChat()">ç™¼é€</button>
            </div>
        </div>
    </div>

    <script>
        // ================= CONFIG =================
        const API_KEY = "AIzaSyCCl7sDW_VsjxTnaYrJqwul3vaKyEnv04g";
        const GAS_URL = "https://script.google.com/macros/s/AKfycbyhCVshR6q1Oo5ntp062zIzGyWuD_Xfb2ZVsz_tR7F9LJ2AekV3Zfv-nprhmcPMTUfr/exec"; 
        // ==========================================

        let studentId = "";
        let currentPhase = 'learning';
        let isFaceLoaded = false;
        let isPaused = false;
        let pyodide = null;
        
        let sessionData = { probTitle:"", probDesc:"", probCode:"", aiScores:[], aiComment:"", reflection:"" };
        let currentPeerProblemTitle = "";

        // ç›£æ§è®Šæ•¸
        let stressScore = 0;
        let tabSwitchCount = 0;
        let faceMissingDuration = 0;
        let learningStartTime = 0;
        
        // ä¿®æ­£é‡é» 2: è¡Œç‚ºè¨ˆæ•¸å™¨
        let mouseDist = 0, lastMouseX = 0, lastMouseY = 0;
        let backspaceCount = 0;

        function loginSystem() {
            const id = document.getElementById('student-id-input').value.trim();
            if(!id) return alert("è«‹è¼¸å…¥å­¸è™Ÿ");
            studentId = id;
            document.getElementById('display-student-id').innerText = "å­¸è™Ÿ: " + id;
            document.getElementById('login-overlay').style.display = 'none';
            init();
        }

        async function init() {
            log('SYS', 'ç³»çµ±å•Ÿå‹•');
            const MODEL_URL = 'https://justadudewhohacks.github.io/face-api.js/models';
            await Promise.all([
                faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                faceapi.nets.faceExpressionNet.loadFromUri(MODEL_URL)
            ]);
            isFaceLoaded = true;
            
            const video = document.getElementById('video');
            const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
            video.srcObject = stream;
            video.addEventListener('play', () => setInterval(monitorLoop, 1000));
            
            try { pyodide = await loadPyodide(); log('SYS','Python Ready'); } catch(e){}

            // è¼¸å…¥äº‹ä»¶ç›£è½ (ä¿®æ­£é‡é» 2)
            document.addEventListener('mousemove', (e) => {
                if(lastMouseX !== 0) {
                    mouseDist += Math.sqrt(Math.pow(e.clientX - lastMouseX, 2) + Math.pow(e.clientY - lastMouseY, 2));
                }
                lastMouseX = e.clientX; lastMouseY = e.clientY;
            });
            document.addEventListener('keydown', (e) => {
                if(e.key === 'Backspace') backspaceCount++;
            });

            setInterval(() => { tabSwitchCount = 0; }, 5000); // 5ç§’é‡ç½®åˆ†é è¨ˆæ•¸
            typeWriterMsg('ai', `ä½ å¥½ï¼Œæˆ‘æ˜¯ä½ çš„ AI å¤¥ä¼´ã€‚è«‹é–‹å§‹å­¸ç¿’ã€‚`);
            learningStartTime = Date.now();
        }

        // ================= æ ¸å¿ƒç›£æ§ (ä¿®æ­£é‡é» 2) =================
        async function monitorLoop() {
            if(isPaused) return;

            let emoDelta = 0;
            let actDelta = 0;
            let status = "æ­£å¸¸";
            let statusClass = "val";

            // 1. è‡‰éƒ¨æƒ…ç·’
            if(isFaceLoaded) {
                const video = document.getElementById('video');
                const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions()).withFaceExpressions();
                if(detections.length > 0) {
                    faceMissingDuration = 0;
                    document.getElementById('face-lock-overlay').style.display = 'none';
                    const ex = detections[0].expressions;
                    const top = Object.entries(ex).sort((a,b) => b[1]-a[1])[0][0];
                    document.getElementById('emo-val').innerText = top;
                    if(['sad', 'angry', 'fearful'].includes(top)) emoDelta += 5;
                } else {
                    faceMissingDuration++;
                    document.getElementById('emo-val').innerText = "è¨Šè™Ÿéºå¤±";
                    if(faceMissingDuration > 3) document.getElementById('face-lock-overlay').style.display = 'flex';
                }
            }

            // 2. è¡Œç‚ºå£“åŠ› (ä¿®æ­£ï¼šç´å…¥æ»‘é¼ èˆ‡éµç›¤)
            // é–¾å€¼ï¼šæ»‘é¼ æ¯ç§’ç§»å‹•è¶…é4000pxï¼Œæˆ–åˆªé™¤éµè¶…é10æ¬¡
            if(mouseDist > 4000) {
                actDelta += 10;
                status = "æ»‘é¼ ç„¦æ…® (Mouse Jitter)";
                statusClass = "val bad";
                log('ACT', `Mouse Jitter Detected (Dist: ${Math.round(mouseDist)})`);
            }
            else if(backspaceCount > 10) {
                actDelta += 10;
                status = "éµç›¤ç„¦æ…® (Typing Rage)";
                statusClass = "val bad";
                log('ACT', `Keyboard Rage Detected (Backspace: ${backspaceCount})`);
            }
            else if(tabSwitchCount > 4) {
                actDelta += 10; 
                status = "é »ç¹åˆ‡æ› (Distracted)"; 
                statusClass = "val warn";
                log('ACT', 'Frequent Tab Switching');
            }

            // é‡ç½®è¨ˆæ•¸å™¨
            mouseDist = 0; 
            backspaceCount = 0;

            document.getElementById('act-val').innerText = status;
            document.getElementById('act-val').className = statusClass;

            // ç¸½å£“åŠ›è¨ˆç®—
            let totalDelta = emoDelta + actDelta;
            if(totalDelta > 0) stressScore += totalDelta;
            else stressScore = Math.max(0, stressScore - 2);

            updateStressBar();
        }

        function updateStressBar() {
            stressScore = Math.min(100, stressScore);
            const bar = document.getElementById('stress-bar');
            bar.style.width = stressScore + "%";
            
            if(stressScore > 85) { bar.style.background = "red"; triggerTherapy(); }
            else if(stressScore > 50) bar.style.background = "orange";
            else bar.style.background = "#00ff9d";
        }

        // ================= æµç¨‹é‚è¼¯ =================
        function switchPhase(phase) {
            tabSwitchCount++;
            currentPhase = phase;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.content-area').forEach(c => c.classList.remove('active'));
            
            const list = ['learning', 'posing', 'human-review', 'ai-review', 'reflection'];
            const idx = list.indexOf(phase);
            document.querySelectorAll('.tab-btn')[idx].classList.add('active');
            document.querySelectorAll('.content-area')[idx].classList.add('active');
            log('NAV', phase);
        }

        function finishLearning() {
            const sec = (Date.now() - learningStartTime)/1000;
            if(sec < 5) { stressScore += 20; typeWriterMsg('ai', 'è®€å¤ªå¿«äº†ï¼è«‹å°ˆå¿ƒã€‚(å£“åŠ›å€¼ä¸Šå‡)'); return; }
            log('LN','å®Œæˆ');
            switchPhase('posing');
        }

        function finishPosing() {
            const t = document.getElementById('pp-title').value;
            const c = document.getElementById('code-editor').value;
            if(!t || !c) return alert("è«‹å¡«å¯«");
            sessionData.probTitle = t; sessionData.probDesc = document.getElementById('pp-desc').value; sessionData.probCode = c;
            log('PP','æš«å­˜');
            switchPhase('human-review');
        }

        async function loadPeerProblem() {
            const btn = document.querySelector('#phase-human-review button');
            btn.innerText = "é€£ç·šä¸­..."; btn.disabled = true;
            try {
                const res = await fetch(`${GAS_URL}?studentId=${studentId}&t=${Date.now()}`);
                const json = await res.json();
                if(json.status === 'success') {
                    const p = json.problem;
                    document.getElementById('hr-title').innerText = p.title;
                    document.getElementById('hr-desc').innerText = p.desc;
                    document.getElementById('hr-code').innerText = p.code;
                    currentPeerProblemTitle = p.title;
                    document.getElementById('human-review-area').style.display = 'block';
                    if(json.note) alert(json.note); 
                } else { alert(json.message); }
            } catch(e) { alert("é€£ç·šå¤±æ•—"); }
            btn.innerText = "ğŸ“¥ è¼‰å…¥åŒå„•æŒ‘æˆ°"; btn.disabled = false;
        }

        async function submitHumanReview() {
            const s = [1,2,3,4,5].map(i=>document.getElementById(`hr-s${i}`).value);
            const c = document.getElementById('hr-comment').value;
            if(!c) return alert("è«‹å¯«è©•èª");
            await sendToGAS({ type:'HUMAN_REVIEW', studentId, targetTitle:currentPeerProblemTitle, scores:s, comment:c });
            alert("è©•åˆ†å·²é€å‡º");
            document.getElementById('human-review-area').style.display='none';
            switchPhase('ai-review');
        }

        async function triggerAIReview() {
            document.getElementById('ai-result').style.display='block';
            document.getElementById('ai-comment-cell').innerText = "AI åˆ†æä¸­...";
            const prompt = `è©•åˆ†ç¨‹å¼é¡Œã€‚é¡Œç›®:${sessionData.probTitle},ä»£ç¢¼:${sessionData.probCode}ã€‚è«‹å›å‚³JSON:{ "scores":[4,3,4,4,5], "comment":"è©•èª" }ã€‚`;
            try {
                const res = await callGemini(prompt);
                const json = JSON.parse(extractJSON(res));
                sessionData.aiScores = json.scores; sessionData.aiComment = json.comment;
                for(let i=0; i<5; i++) document.getElementById(`ai-s${i+1}`).innerText = json.scores[i];
                document.getElementById('ai-comment-cell').innerText = "";
                typeWriterText(document.getElementById('ai-comment-cell'), json.comment);
            } catch(e) { alert("AI Error"); }
        }

        async function submitAll() {
            const r = document.getElementById('rf-content').value;
            if(!r) return alert("è«‹å¯«åæ€");
            sessionData.reflection = r;
            await sendToGAS({ type:'FULL_RECORD', studentId, ...sessionData });
            alert("è³‡æ–™ä¸Šå‚³æˆåŠŸï¼");
        }

        // ================= å·¥å…· =================
        function typeWriterMsg(role, text) {
            const box = document.getElementById('chat-msgs');
            const div = document.createElement('div');
            div.className = `msg ${role} typing-cursor`;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
            let i = 0;
            const t = setInterval(()=>{
                div.innerText += text.charAt(i++);
                box.scrollTop = box.scrollHeight;
                if(i>=text.length){ clearInterval(t); div.classList.remove('typing-cursor'); }
            }, 30);
        }

        function typeWriterText(el, text) {
            let i = 0;
            const t = setInterval(()=>{
                el.innerText += text.charAt(i++);
                if(i>=text.length) clearInterval(t);
            }, 20);
        }

        async function runPython() {
            const c = document.getElementById('code-editor').value;
            // é€™è£¡å¯ä»¥åŠ å…¥è¼¸å‡ºè¦–çª—çš„é¡¯ç¤ºé‚è¼¯ï¼Œç›®å‰ç°¡åŒ–
            if(!pyodide) return;
            try { await pyodide.runPythonAsync(c); } catch(e){}
        }

        async function sendChat() {
            const v = document.getElementById('chat-input').value;
            if(!v) return;
            const box = document.getElementById('chat-msgs');
            const div = document.createElement('div'); div.className="msg user"; div.innerText=v;
            box.appendChild(div); box.scrollTop=box.scrollHeight;
            document.getElementById('chat-input').value="";
            const r = await callGemini(`ä½ æ˜¯è€å¸«ã€‚å­¸ç”Ÿ:${v}ã€‚ç°¡çŸ­å›è¦†ã€‚`);
            typeWriterMsg('ai', r);
        }

        async function callGemini(text) {
            if(!API_KEY || API_KEY.includes("è«‹å¡«å…¥")) return "{}";
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${API_KEY}`;
            const r = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({contents:[{parts:[{text}]}]}) });
            const d = await r.json();
            return d.candidates[0].content.parts[0].text;
        }

        function extractJSON(str) {
            const s = str.indexOf('{'); const e = str.lastIndexOf('}');
            return (s!==-1 && e!==-1) ? str.substring(s, e+1) : "{}";
        }

        async function sendToGAS(pl) {
            if(!GAS_URL.startsWith("http")) return;
            await fetch(GAS_URL, { method:'POST', mode:'no-cors', headers:{'Content-Type':'application/json'}, body:JSON.stringify(pl) });
        }

        function log(type, detail) {
            const box = document.getElementById('log-box');
            const div = document.createElement('div'); div.className='log-entry';
            div.innerText=`[${new Date().toLocaleTimeString()}] ${type}: ${detail}`;
            box.appendChild(div); box.scrollTop=box.scrollHeight;
            sendToGAS({ type:'LOG', studentId, action:type, detail });
        }
        
        function triggerTherapy() {
            if(isPaused) return; isPaused = true;
            document.getElementById('therapy-overlay').style.display='flex';
            setTimeout(()=>{
                document.getElementById('therapy-text').innerText="æ·±å‘¼å¸... 3... 2... 1...";
                document.getElementById('btn-resume').style.opacity='1';
            }, 3000);
        }
        function stopTherapy() {
            document.getElementById('therapy-overlay').style.display='none';
            stressScore=40; isPaused=false;
        }
    </script>
</body>
</html>
