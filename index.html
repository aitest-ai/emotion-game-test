<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Code Nexus - Ultimate Full Version (Fixed)</title>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        /* === å…¨å±€åŸºç¤è¨­å®š === */
        :root { --bg-color: #050505; --panel-bg: #101010; --accent: #00ff9d; --accent-dim: #005533; --danger: #ff3333; --warning: #ffcc00; --text: #e0e0e0; --border: #333; }
        body { background: var(--bg-color); color: var(--text); font-family: 'Microsoft JhengHei', sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* === å·¦å´é¢æ¿ (ç›£æ¸¬å€) === */
        .panel-left { width: 320px; min-width: 320px; background: var(--panel-bg); border-right: 1px solid var(--border); padding: 15px; display: flex; flex-direction: column; height: 100vh; box-sizing: border-box; }
        .cam-box { flex: 0 0 200px; background: #000; border: 2px solid var(--accent); border-radius: 6px; overflow: hidden; position: relative; margin-bottom: 10px; }
        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); } /* é¡é ­æ°´å¹³ç¿»è½‰ */
        .status-box { flex: 0 0 auto; background: #1a1a1a; padding: 10px; margin-bottom: 10px; border-radius: 6px; border: 1px solid #333; font-size: 0.9em; }
        .metric-row { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .val { font-weight: bold; color: var(--accent); }
        .stress-bar-bg { height: 6px; background: #333; border-radius: 3px; margin-top: 5px; overflow: hidden; }
        .stress-bar { height: 100%; width: 0%; background: var(--accent); transition: width 0.5s; }
        .log-header { flex: 0 0 auto; font-size: 0.8em; color: #666; margin-bottom: 5px; }
        #log-box { flex: 1 1 auto; background: #000; padding: 5px; font-family: monospace; font-size: 0.75em; color: #888; overflow-y: auto; border: 1px solid #333; }
        .log-entry { margin-bottom: 2px; border-bottom: 1px solid #222; padding-bottom: 2px; }

        /* === å³å´é¢æ¿ (æ“ä½œå€) === */
        .panel-right { flex: 1; display: flex; flex-direction: column; height: 100vh; overflow: hidden; padding: 20px; box-sizing: border-box; }
        
        /* åˆ†é æ¨™ç±¤ */
        .nav-tabs { display: flex; gap: 8px; margin-bottom: 15px; flex: 0 0 auto; overflow-x: auto; }
        .tab-btn { background: #222; border: 1px solid #444; color: #aaa; padding: 8px 12px; cursor: pointer; border-radius: 4px; transition: 0.3s; white-space: nowrap; font-size: 0.9em; }
        .tab-btn.active { background: var(--accent-dim); color: white; border-color: var(--accent); }

        /* ä¸­é–“å…§å®¹å€ */
        .content-area { display: none; flex-direction: column; flex: 1; min-height: 0; overflow-y: auto; padding-right: 5px; margin-bottom: 10px; }
        .content-area.active { display: flex; }

        /* åº•éƒ¨èŠå¤©å®¤ */
        #chat-panel { flex: 0 0 200px; height: 200px; border-top: 1px solid #333; background: #080808; display: flex; flex-direction: column; padding: 10px; box-sizing: border-box; overflow: hidden; }
        #chat-msgs { flex: 1; overflow-y: auto; margin-bottom: 10px; min-height: 0; }

        /* å…ƒä»¶æ¨£å¼ */
        input, textarea, select { width: 100%; background: #1a1a1a; border: 1px solid #333; color: white; padding: 10px; border-radius: 4px; box-sizing: border-box; margin-bottom: 10px; }
        textarea { resize: vertical; font-family: monospace; }
        .editor-container { flex: 0 0 250px; display: flex; flex-direction: column; border: 1px solid #333; border-radius: 6px; overflow: hidden; margin-bottom: 10px; }
        .code-area { flex: 1; background: #0c0c0c; color: #ddd; padding: 15px; border:none; outline:none; font-family: 'Consolas', monospace; resize:none; font-size: 14px; }
        .output-area { height: 100px; background: #000; color: #aaa; padding: 10px; font-family: monospace; border-top: 1px solid #333; overflow-y: auto; white-space: pre-wrap; }
        
        .btn-action { background: var(--accent-dim); color: white; border: 1px solid var(--accent); padding: 8px 20px; cursor: pointer; border-radius: 4px; flex: 0 0 auto; }
        .btn-action:hover { background: var(--accent); color: black; }
        .btn-action:disabled { background: #333; border-color: #555; color: #777; cursor: not-allowed; }

        /* å½±ç‰‡èˆ‡äº’å‹•å€ */
        .video-wrapper { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; margin-bottom: 15px; border: 1px solid #444; border-radius: 8px; }
        .video-wrapper iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .qa-section { background: #1a1a1a; padding: 15px; border-radius: 6px; margin-top: 10px; border-left: 3px solid #0099ff; }

        /* è¡¨æ ¼æ¨£å¼ */
        .score-table { width: 100%; border-collapse: collapse; margin-top: 10px; table-layout: fixed; }
        .score-table td, .score-table th { border: 1px solid #333; padding: 8px; text-align: center; vertical-align: middle; }
        .score-table th { background: #222; color: var(--accent); width: 20%; }
        .score-table td.comment-cell { text-align: left; vertical-align: top; white-space: pre-wrap; height: 80px;}

        /* èŠå¤©è¨Šæ¯ */
        .msg { padding: 8px 12px; margin-bottom: 5px; border-radius: 4px; font-size: 0.9em; max-width: 90%; word-wrap: break-word; line-height: 1.5; }
        .msg.ai { color: var(--accent); background: #112211; border-left: 3px solid var(--accent); align-self: flex-start; }
        .msg.user { color: #fff; background: #004455; align-self: flex-end; }
        .typing-cursor::after { content: 'â–‹'; animation: blink 1s infinite; color: var(--accent); }
        @keyframes blink { 0%, 100% {opacity: 1;} 50% {opacity: 0;} }

        /* é›£åº¦é¸æ“‡æŒ‰éˆ• (ç·´ç¿’å€ç”¨) */
        .diff-btn { background: #222; border: 1px solid #444; color: #ccc; padding: 10px 20px; margin-right: 10px; cursor: pointer; border-radius: 20px; transition: 0.3s; }
        .diff-btn:hover { border-color: var(--accent); color: white; }
        .diff-btn.active { background: var(--accent); color: black; font-weight: bold; border-color: var(--accent); }

        /* è¦†è“‹å±¤ (Overlay) */
        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(5,5,5,0.95); z-index: 1000; display: none; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        #face-lock-overlay { backdrop-filter: blur(10px); background: rgba(0,0,0,0.85); z-index: 3000; }
        .lock-icon { font-size: 50px; margin-bottom: 20px; animation: pulse 1s infinite; }
        @keyframes pulse { 0% {transform: scale(1);} 50% {transform: scale(1.1);} 100% {transform: scale(1);} }
        .login-box { width: 350px; padding: 40px; border: 1px solid var(--accent); border-radius: 10px; background: #111; }
    </style>
</head>
<body>

    <div id="login-overlay" class="overlay" style="display:flex;">
        <div class="login-box">
            <h2 style="color:var(--accent);">CODE NEXUS</h2>
            <p style="color:#888;">è«‹è¼¸å…¥å­¸è™Ÿå•Ÿå‹•ç³»çµ±</p>
            <input type="text" id="student-id-input" placeholder="å­¸è™Ÿ" style="text-align:center;">
            <button class="btn-action" onclick="loginSystem()" style="width:100%;">å•Ÿå‹•ç³»çµ± â–¶</button>
        </div>
    </div>

    <div id="face-lock-overlay" class="overlay">
        <div class="lock-icon">âš ï¸</div>
        <h2 style="color:var(--warning);">ç³»çµ±æš«åœ</h2>
        <p style="color:#ccc;">åµæ¸¬ä¸åˆ°è‡‰éƒ¨ï¼Œè«‹å›åˆ°åº§ä½ã€‚</p>
    </div>

    <div id="therapy-overlay" class="overlay">
        <h2 style="color:var(--danger)">âš ï¸ å£“åŠ›éè¼‰</h2>
        <p>åµæ¸¬åˆ°é«˜åº¦ç„¦æ…®ã€‚è«‹ä¼‘æ¯ã€‚</p>
        <div id="therapy-text" style="color:#fff; margin:20px 0; font-size:1.2em;">è¼‰å…¥ä¸­...</div>
        <button class="btn-action" id="btn-resume" onclick="stopTherapy()" style="opacity:0;">ç¹¼çºŒä»»å‹™</button>
    </div>

    <div class="panel-left">
        <div class="header">NEXUS</div>
        <div id="display-student-id" style="text-align:center; color:#888; margin-bottom:10px;">æœªç™»å…¥</div>
        <div class="cam-box"><video id="video" autoplay muted playsinline></video></div>
        <div class="status-box">
            <div class="metric-row"><span>æƒ…ç·’:</span> <span id="emo-val" class="val">--</span></div>
            <div class="metric-row"><span>ç‹€æ…‹:</span> <span id="act-val" class="val" style="color:gray">æ­£å¸¸</span></div>
            <div style="margin-top:5px; font-size:0.8em; color:gray;">å£“åŠ›æŒ‡æ•¸ (Stress)</div>
            <div class="stress-bar-bg"><div id="stress-bar" class="stress-bar"></div></div>
        </div>
        <div class="log-header">ç³»çµ±æ—¥èªŒ</div>
        <div id="log-box"></div>
    </div>

    <div class="panel-right">
        <div class="nav-tabs">
            <button class="tab-btn active" onclick="switchPhase('learning')">1. å­¸ç¿’ (LN)</button>
            <button class="tab-btn" onclick="switchPhase('exercise')">2. ç·´ç¿’ (EX)</button>
            <button class="tab-btn" onclick="switchPhase('posing')">3. æ“¬é¡Œ (PP)</button>
            <button class="tab-btn" onclick="switchPhase('ai-review')">4. AI è©•æˆ‘ (PA)</button> 
            <button class="tab-btn" onclick="switchPhase('human-review')">5. è©•åŒå„• (HR)</button> 
            <button class="tab-btn" onclick="switchPhase('reflection')">6. åæ€ (RF)</button>
        </div>

        <div id="phase-learning" class="content-area active">
            <div style="background:#151515; padding:20px; border-radius:8px; border-left:4px solid var(--accent);">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h2 id="lesson-title">è¼‰å…¥æ•™æä¸­...</h2>
                    <span id="reading-timer" style="color:#888; font-family:monospace;">00:00</span>
                </div>
                <div class="video-wrapper"><div id="youtube-player"></div></div>
                <p id="material-summary">...</p>
                <pre id="material-code" style="background:#222; padding:10px; color:#aaa; margin-top:0;">...</pre>
                <div class="qa-section">
                    <h4 style="margin-top:0; color:#0099ff;">ğŸ™‹â€â™‚ï¸ å°å½±ç‰‡æœ‰ç–‘å•ï¼Ÿ</h4>
                    <div style="display:flex; gap:10px;">
                        <input id="material-question" placeholder="ä¾‹å¦‚ï¼šç‚ºä»€éº¼é€™è£¡æ˜¯ 80 åˆ†ï¼Ÿ" onkeypress="if(event.key==='Enter') sendMaterialQuestion()">
                        <button class="btn-action" style="background:#004466; border-color:#0099ff;" onclick="sendMaterialQuestion()">æå•</button>
                    </div>
                </div>
                <hr style="border-color:#333; margin:20px 0;">
                <button class="btn-action" onclick="finishLearning()">âœ… å½±ç‰‡çœ‹å®Œï¼Œé€²å…¥ç·´ç¿’é¡Œ</button>
            </div>
        </div>

        <div id="phase-exercise" class="content-area">
            <h3>ğŸ‹ï¸â€â™‚ï¸ å¯¦ä½œç·´ç¿’ï¼šAI å‡ºé¡Œ</h3>
            <p style="color:#aaa;">AI å°‡æ ¹æ“šå½±ç‰‡å…§å®¹ç”Ÿæˆä¸‰ç¨®é›£åº¦çš„é¡Œç›®ã€‚è«‹è‡³å°‘å®Œæˆä¸€é¡Œä»¥è§£é–ä¸‹ä¸€éšæ®µã€‚</p>
            
            <div id="ex-gen-section">
                <button class="btn-action" onclick="generatePracticeProblems()" id="btn-gen-ex">ğŸ¤– è®“ AI ç”Ÿæˆé¡Œç›®</button>
            </div>

            <div id="ex-solve-section" style="display:none; margin-top:20px;">
                <div style="margin-bottom:15px;">
                    <button class="diff-btn" onclick="selectDifficulty('low')" id="btn-low">ğŸŸ¢ åŸºç¤é¡Œ</button>
                    <button class="diff-btn" onclick="selectDifficulty('mid')" id="btn-mid">ğŸŸ¡ é€²éšé¡Œ</button>
                    <button class="diff-btn" onclick="selectDifficulty('high')" id="btn-high">ğŸ”´ æŒ‘æˆ°é¡Œ</button>
                </div>
                
                <div style="border:1px solid #444; padding:20px; border-radius:8px; background:#111;">
                    <h4 id="ex-q-title" style="color:var(--accent); margin-top:0;">è«‹é¸æ“‡é›£åº¦</h4>
                    <p id="ex-q-desc" style="white-space: pre-wrap;">...</p>
                    
                    <label>ä½ çš„è§£ç­”ï¼š</label>
                    <div class="editor-container">
                        <textarea id="ex-code-editor" class="code-area" placeholder="# åœ¨é€™è£¡å¯«ä¸‹ä½ çš„ç¨‹å¼ç¢¼..."></textarea>
                        <div id="ex-output" class="output-area">ç­‰å¾…åŸ·è¡Œ...</div>
                    </div>
                    <p id="ex-hint-text" style="color: #888; font-size: 0.9em; margin-top: 5px; background: #222; padding: 5px; border-radius: 4px;"></p>
                    
                    <div style="display:flex; justify-content:space-between;">
                        <button class="btn-action" style="background:#444;" onclick="runExPython()">â–¶ æ¸¬è©¦åŸ·è¡Œ</button>
                        <button class="btn-action" onclick="checkExAnswer()" id="btn-check-ex">ğŸ“ æäº¤çµ¦ AI æª¢æŸ¥</button>
                    </div>
                </div>
                
                <div id="ex-feedback" style="margin-top:15px; display:none; padding:15px; border-radius:6px; background:#222; border-left:4px solid #fff;">
                    <strong>AI æª¢æŸ¥çµæœï¼š</strong> <span id="ex-result-text"></span>
                    <br><br>
                    <button class="btn-action" id="btn-next-phase" style="display:none;" onclick="finishExercise()">å‰å¾€æ“¬é¡Œéšæ®µ â¡</button>
                </div>
            </div>
        </div>

        <div id="phase-posing" class="content-area">
            <label>é¡Œç›®åç¨±</label><input id="pp-title" placeholder="ä¾‹å¦‚ï¼šåˆ¤æ–·å¥‡å¶æ•¸">
            <label>é¡Œç›®æ•˜è¿°</label><textarea id="pp-desc" style="height:80px;"></textarea>
            <label>åƒè€ƒè§£ç­”ä»£ç¢¼</label>
            <div class="editor-container">
                <textarea id="code-editor" class="code-area" placeholder="print('Hello World')"></textarea>
                <div id="output" class="output-area">ç­‰å¾…åŸ·è¡Œ...</div>
            </div>
            <div style="display:flex; justify-content:space-between; margin-top:10px;">
                 <button class="btn-action" style="background:#444;" onclick="runPython()">â–¶ åŸ·è¡Œä»£ç¢¼</button>
                 <button class="btn-action" onclick="finishPosing()">æš«å­˜ä¸¦æäº¤çµ¦ AI â¡</button>
            </div>
        </div>

        <div id="phase-ai-review" class="content-area">
            <h3>ğŸ¤– AI è©•åˆ†ä½ çš„é¡Œç›®</h3>
            <button class="btn-action" onclick="triggerAIReview()">å•Ÿå‹• AI è©•åˆ†</button>
            <div id="ai-result" style="display:none; margin-top:15px;">
                <table class="score-table">
                    <tr><th>å‘åº¦</th><th>å¾—åˆ†</th><th>AI è©•èª</th></tr>
                    <tr><td>é¡Œç›®æ­£ç¢º</td><td id="ai-s1">-</td><td rowspan="5" id="ai-comment-cell" class="comment-cell"></td></tr>
                    <tr><td>è¤‡é›œåº¦</td><td id="ai-s2">-</td></tr>
                    <tr><td>å¯¦ç”¨æ€§</td><td id="ai-s3">-</td></tr>
                    <tr><td>ä»£ç¢¼æ­£ç¢º</td><td id="ai-s4">-</td></tr>
                    <tr><td>å¯è®€æ€§</td><td id="ai-s5">-</td></tr>
                </table>
                <br><button class="btn-action" onclick="switchPhase('human-review')">å‰å¾€åŒå„•äº’è©• â¡</button>
            </div>
        </div>

        <div id="phase-human-review" class="content-area">
            <h3>ğŸ‘¥ è©•åˆ†å…¶ä»–åŒå­¸çš„é¡Œç›®</h3>
            <div style="background:#222; padding:10px; margin-bottom:15px; border-radius:4px; font-size:0.9em; color:#aaa;">
                <span style="color:var(--accent)">â˜… è¦å‰‡èªªæ˜ï¼š</span> ç‚ºäº†ç¢ºä¿è©•åˆ†å…¬æ­£ï¼Œè«‹å…ˆè©¦è‘—è§£å‡ºåŒå­¸çš„é¡Œç›®ï¼Œç³»çµ±æ‰æœƒé¡¯ç¤ºåƒè€ƒè§£ç­”èˆ‡è©•åˆ†è¡¨ã€‚
            </div>
            <button class="btn-action" onclick="loadPeerProblem()" style="background:#444; margin-bottom:15px;">ğŸ“¥ è¼‰å…¥åŒå„•æŒ‘æˆ°</button>
            
            <div id="human-review-container" style="display:none; border:1px solid #333; padding:15px; border-radius:6px;">
                <h4 id="hr-title" style="color:var(--accent); margin-top:0;"></h4>
                <p id="hr-desc" style="color:#aaa; background:#111; padding:10px; border-radius:4px; margin-bottom:20px;"></p>

                <div id="hr-stage-1-solve">
                    <label style="color:#fff;">è«‹å…ˆè©¦è‘—è§£é¡Œ (Testing Zone)ï¼š</label>
                    <div class="editor-container">
                        <textarea id="hr-attempt-editor" class="code-area" placeholder="# åœ¨é€™è£¡è©¦å¯«åŒå­¸çš„é¡Œç›®..."></textarea>
                        <div id="hr-attempt-output" class="output-area">ç­‰å¾…æ¸¬è©¦...</div>
                    </div>
                    <div style="display:flex; justify-content:space-between;">
                        <button class="btn-action" style="background:#444;" onclick="runPeerAttempt()">â–¶ æ¸¬è©¦æˆ‘çš„ä»£ç¢¼</button>
                        <button class="btn-action" onclick="revealPeerGrading()">ğŸ‘€ æˆ‘è©¦éäº†ï¼Œé¡¯ç¤ºè§£ç­”èˆ‡è©•åˆ†</button>
                    </div>
                </div>

                <div id="hr-stage-2-grade" style="display:none; margin-top:20px; border-top:1px solid #333; padding-top:20px;">
                    <label style="color:var(--warning);">åŒå­¸çš„åƒè€ƒè§£ç­”ï¼š</label>
                    <pre id="hr-code" style="background:#222; padding:10px; overflow-x:auto; margin-bottom:20px;"></pre>
                    
                    <label>çµ¦äºˆè©•åˆ†ï¼š</label>
                    <table class="score-table">
                        <tr><th>æ­£ç¢º</th><th>è¤‡é›œ</th><th>å¯¦ç”¨</th><th>ä»£ç¢¼</th><th>å¯è®€</th></tr>
                        <tr>
                            <td><input type="number" id="hr-s1" min="1" max="5" value="3"></td>
                            <td><input type="number" id="hr-s2" min="1" max="5" value="3"></td>
                            <td><input type="number" id="hr-s3" min="1" max="5" value="3"></td>
                            <td><input type="number" id="hr-s4" min="1" max="5" value="3"></td>
                            <td><input type="number" id="hr-s5" min="1" max="5" value="3"></td>
                        </tr>
                    </table>
                    <textarea id="hr-comment" style="margin-top:10px; height:60px;" placeholder="è©•èª..."></textarea>
                    <button class="btn-action" onclick="submitHumanReview()">ğŸ“¤ é€å‡ºè©•åˆ†</button>
                </div>
            </div>
        </div>

        <div id="phase-reflection" class="content-area">
            <h3>ğŸ¤” å­¸ç¿’åæ€</h3>
            <textarea id="rf-content" style="height:150px;"></textarea>
            <button class="btn-action" onclick="submitAll()">âœ… æäº¤æ‰€æœ‰æˆæœ</button>
        </div>

        <div id="chat-panel">
            <div id="chat-msgs"></div>
            <div style="display:flex; gap:10px;">
                <input id="chat-input" placeholder="è·Ÿæ™ºæ…§åŠ©æ•™å°è©±..." onkeypress="if(event.key==='Enter') sendChat()">
                <button class="btn-action" onclick="sendChat()">ç™¼é€</button>
            </div>
        </div>
    </div>

    <script>
        // ===============================================
        // â˜…â˜…â˜… è€å¸«è¨­å®šå€ (LESSON CONFIG) â˜…â˜…â˜…
        // ===============================================
        
        const LESSON_CONFIG = {
            youtubeId: "onrMi-D7lvY", 
            title: "ğŸ¬ å–®å…ƒå½±ç‰‡ï¼šPython æ¢ä»¶åˆ¤æ–·èˆ‡é‚è¼¯",
            summary: "å½±ç‰‡é‡é»ï¼šPython ä½¿ç”¨ if, elif, else ä¾†é€²è¡Œæ¢ä»¶åˆ¤æ–·ã€‚ç¸®æ’ (Indentation) éå¸¸é‡è¦ï¼Œæ±ºå®šäº†ç¨‹å¼ç¢¼å€å¡Šçš„ç¯„åœã€‚",
            code: `score = 80
if score >= 90:
    print("Grade A")
elif score >= 60:
    print("Pass")
else:
    print("Fail")`
        };

        // ===============================================
        // ç³»çµ±æ ¸å¿ƒä»£ç¢¼ (Core System Logic)
        // ===============================================

        // è«‹ç¢ºèªæ‚¨çš„ Google Apps Script URL æ˜¯ v18.0 ç‰ˆ
        const GAS_URL = "https://script.google.com/macros/s/AKfycbzkAH1B96FAMUhSf-n6ET5x8h8BXtXpxgIApmQraqk39rIZOhgUuOi94zmy1AuZMXAqXg/exec"; 
        
        let studentId = "";
        let currentPhase = 'learning';
        let isFaceLoaded = false, isPaused = false, pyodide = null;
        let sessionData = { probTitle:"", probDesc:"", probCode:"", aiScores:[], aiComment:"", reflection:"" };
        let currentPeerProblemTitle = "";
        let currentPeerRefCode = ""; 
        let stressScore = 0, tabSwitchCount = 0, faceMissingDuration = 0, learningStartTime = 0;
        let mouseDist = 0, lastMouseX = 0, lastMouseY = 0, backspaceCount = 0, lastEmotion = "";
        let chatHistory = [];
        let ytPlayer = null;
        let readTimerInterval = null;
        let readSeconds = 0;

        let generatedProblems = null; 
        let currentDifficulty = ''; 

        const PROMPT_STRICT_GRADING = `ä½ ç¾åœ¨æ˜¯ä¸€ä½é›»è…¦ç§‘å­¸å°ˆå®¶ã€‚è«‹å°å­¸ç”Ÿçš„é¡Œç›®èˆ‡ä»£ç¢¼é€²è¡Œè©•åˆ†(1-5åˆ†)ã€‚å›å‚³ JSONã€‚`;
        const PROMPT_THERAPY_STYLE = `ä½¿ç”¨è€…å£“åŠ›æŒ‡æ•¸éé«˜ã€‚è«‹è¬›ç¬‘è©±æˆ–é¼“å‹µã€‚ç¹é«”ä¸­æ–‡ã€‚`;

        (function initLessonContent() {
            document.getElementById('lesson-title').innerText = LESSON_CONFIG.title;
            document.getElementById('material-summary').innerText = LESSON_CONFIG.summary;
            document.getElementById('material-code').innerText = LESSON_CONFIG.code;
        })();

        // ===============================================
        // YouTube API Fix (å‹•æ…‹è¼‰å…¥ï¼Œè§£æ±º API Race Condition)
        // ===============================================
        
        function onYouTubeIframeAPIReady() {
            ytPlayer = new YT.Player('youtube-player', {
                height: '100%',
                width: '100%',
                videoId: LESSON_CONFIG.youtubeId,
                playerVars: { 'playsinline': 1, 'rel': 0 },
                events: { 'onStateChange': onPlayerStateChange }
            });
        }

        // å‹•æ…‹è¼‰å…¥è…³æœ¬
        (function loadYoutubeAPI() {
            var tag = document.createElement('script');
            tag.src = "https://www.youtube.com/iframe_api";
            var firstScriptTag = document.getElementsByTagName('script')[0];
            firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
        })();

        function onPlayerStateChange(event) {
            let stateStr = "";
            switch(event.data) {
                case YT.PlayerState.PLAYING: stateStr = "VIDEO_PLAY"; startReadTimer(); break;
                case YT.PlayerState.PAUSED: stateStr = "VIDEO_PAUSE"; stopReadTimer(); break;
                case YT.PlayerState.ENDED: stateStr = "VIDEO_END"; stopReadTimer(); break;
            }
            if(stateStr) log('ACT', `${stateStr} at ${Math.floor(ytPlayer.getCurrentTime())}s`);
        }
        function startReadTimer() {
            if(readTimerInterval) return;
            readTimerInterval = setInterval(() => {
                readSeconds++;
                const m = Math.floor(readSeconds / 60).toString().padStart(2, '0');
                const s = (readSeconds % 60).toString().padStart(2, '0');
                document.getElementById('reading-timer').innerText = `å­¸ç¿’æ™‚é–“: ${m}:${s}`;
            }, 1000);
        }
        function stopReadTimer() { if(readTimerInterval) { clearInterval(readTimerInterval); readTimerInterval = null; } }

        // ===============================================
        // Phase 2: AI ç·´ç¿’å€é‚è¼¯ (ä¿®æ­£ç‰ˆï¼šæç¤ºåœ¨ä¸‹æ–¹)
        // ===============================================
        async function generatePracticeProblems() {
            const btn = document.getElementById('btn-gen-ex');
            btn.innerText = "ç”Ÿæˆä¸­ (AI æ­£åœ¨æ€è€ƒ)..."; btn.disabled = true;
            const prompt = `[ä»»å‹™] è«‹æ ¹æ“šä»¥ä¸‹æ•™æå…§å®¹ï¼Œè¨­è¨ˆ 3 é“ Python ç·´ç¿’é¡Œï¼ˆä½ã€ä¸­ã€é«˜ä¸‰ç¨®é›£åº¦ï¼‰ã€‚\n[æ•™æé‡é»] ${LESSON_CONFIG.summary}\n[æ•™æç¯„ä¾‹] ${LESSON_CONFIG.code}\nè«‹å›å‚³åš´æ ¼çš„ JSON æ ¼å¼: { "low": { "title": "...", "desc": "...", "hint": "..." }, "mid": { ... }, "high": { ... } }`;

            try {
                const r = await callGemini(prompt, "You are a JSON generator.");
                generatedProblems = JSON.parse(extractJSON(r));
                document.getElementById('ex-gen-section').style.display = 'none';
                document.getElementById('ex-solve-section').style.display = 'block';
                selectDifficulty('low');
                log('EX', 'AI Generated Problems');
                typeWriterMsg('ai', 'æˆ‘å·²ç¶“æ ¹æ“šå½±ç‰‡æº–å‚™å¥½ç·´ç¿’é¡Œäº†ï¼Œè«‹è©¦è‘—è§£è§£çœ‹ï¼');
            } catch(e) { 
                alert("ç”Ÿæˆå¤±æ•—ï¼Œè«‹é‡è©¦"); 
                btn.innerText = "ğŸ¤– è®“ AI ç”Ÿæˆé¡Œç›®"; btn.disabled = false;
            }
        }

        function selectDifficulty(level) {
            if(!generatedProblems) return;
            currentDifficulty = level;
            document.querySelectorAll('.diff-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`btn-${level}`).classList.add('active');
            const prob = generatedProblems[level];
            document.getElementById('ex-q-title').innerText = `${prob.title} (${level.toUpperCase()})`;
            document.getElementById('ex-q-desc').innerText = prob.desc;
            
            // â˜…â˜…â˜… ä¿®æ”¹è™•ï¼šæ¸…ç©ºç·¨è¼¯å™¨ï¼Œå°‡æç¤ºæ–‡å­—å¡«å…¥ä¸‹æ–¹å€åŸŸ â˜…â˜…â˜…
            document.getElementById('ex-code-editor').value = ""; 
            document.getElementById('ex-hint-text').innerText = "ğŸ’¡ æç¤ºï¼š" + (prob.hint || "ç„¡");
            
            document.getElementById('ex-result-text').innerText = "";
            document.getElementById('ex-feedback').style.display = "none";
        }

        async function runExPython() {
            const code = document.getElementById('ex-code-editor').value;
            const outputBox = document.getElementById('ex-output');
            outputBox.innerText = ">>> Executing...\n";
            if (!pyodide) { outputBox.innerText += "Python loading...\n"; return; }
            try { pyodide.setStdout({ batched: (msg) => { outputBox.innerText += msg + "\n"; } }); await pyodide.runPythonAsync(code); } catch (err) { outputBox.innerText += "Error:\n" + err; }
        }

        async function checkExAnswer() {
            if(!generatedProblems) return;
            const code = document.getElementById('ex-code-editor').value;
            const currentProb = generatedProblems[currentDifficulty];
            const btn = document.getElementById('btn-check-ex');
            btn.innerText = "æª¢æŸ¥ä¸­..."; btn.disabled = true;
            const prompt = `[é¡Œç›®] ${currentProb.title}\n[æè¿°] ${currentProb.desc}\n[å­¸ç”Ÿä»£ç¢¼]\n${code}\nè«‹åˆ¤æ–·å°éŒ¯å›å‚³ JSON: { "correct": true/false, "feedback": "..." }`;

            try {
                const r = await callGemini(prompt, "You are a Python Tutor.");
                const json = JSON.parse(extractJSON(r));
                const fbBox = document.getElementById('ex-feedback');
                const nextBtn = document.getElementById('btn-next-phase');
                fbBox.style.display = 'block';
                document.getElementById('ex-result-text').innerText = json.feedback;
                
                await sendToGAS({ type: 'PHASE_2_EXERCISE', studentId, difficulty: currentDifficulty, title: currentProb.title, code: code, passed: json.correct?"PASS":"FAIL", feedback: json.feedback });

                if(json.correct) { fbBox.style.borderColor = "#00ff9d"; nextBtn.style.display = 'inline-block'; log('EX', `Solved ${currentDifficulty} - Correct`); } 
                else { fbBox.style.borderColor = "#ff3333"; log('EX', `Solved ${currentDifficulty} - Incorrect`); }
            } catch(e) { alert("AI æª¢æŸ¥éŒ¯èª¤"); }
            btn.innerText = "ğŸ“ æäº¤çµ¦ AI æª¢æŸ¥"; btn.disabled = false;
        }

        function finishExercise() { switchPhase('posing'); typeWriterMsg('ai', 'å¤ªæ£’äº†ï¼ä½ å·²ç¶“æŒæ¡äº†åŸºç¤ï¼Œç¾åœ¨è©¦è‘—è‡ªå·±å‡ºé¡Œè€ƒè€ƒåŒå­¸å§ï¼'); }

        // ===============================================
        // Phase 5: Peer Review (å…ˆè§£é¡Œå¾Œè©•åˆ†)
        // ===============================================
        async function loadPeerProblem() {
            const btn = document.querySelector('#phase-human-review button'); btn.innerText = "é€£ç·šä¸­..."; btn.disabled = true;
            try { 
                const res = await fetch(`${GAS_URL}?studentId=${studentId}&t=${Date.now()}`); 
                const json = await res.json(); 
                if(json.status === 'success') { 
                    const p = json.problem; 
                    document.getElementById('hr-title').innerText = p.title; 
                    document.getElementById('hr-desc').innerText = p.desc; 
                    currentPeerRefCode = p.code; 
                    currentPeerProblemTitle = p.title; 
                    
                    document.getElementById('human-review-container').style.display = 'block';
                    document.getElementById('hr-stage-1-solve').style.display = 'block'; 
                    document.getElementById('hr-stage-2-grade').style.display = 'none'; 
                    document.getElementById('hr-attempt-editor').value = ""; 
                    document.getElementById('hr-attempt-output').innerText = "ç­‰å¾…æ¸¬è©¦...";

                    if(json.note) alert(json.note); 
                } else { alert(json.message); } 
            } catch(e) { alert("é€£ç·šå¤±æ•—"); } 
            btn.innerText = "ğŸ“¥ è¼‰å…¥åŒå„•æŒ‘æˆ°"; btn.disabled = false;
        }

        async function runPeerAttempt() {
            const code = document.getElementById('hr-attempt-editor').value;
            const outputBox = document.getElementById('hr-attempt-output');
            outputBox.innerText = ">>> Testing Peer Code...\n";
            if (!pyodide) { outputBox.innerText += "Python loading...\n"; return; }
            try { pyodide.setStdout({ batched: (msg) => { outputBox.innerText += msg + "\n"; } }); await pyodide.runPythonAsync(code); } catch (err) { outputBox.innerText += "Error:\n" + err; }
        }

        function revealPeerGrading() {
            const attempt = document.getElementById('hr-attempt-editor').value.trim();
            if(attempt.length < 5) { alert("è«‹å…ˆè©¦è‘—å¯«å¯«çœ‹ä»£ç¢¼ï¼Œå†ä¾†çœ‹è§£ç­”å–”ï¼"); return; }
            document.getElementById('hr-stage-1-solve').style.display = 'none'; 
            document.getElementById('hr-stage-2-grade').style.display = 'block'; 
            document.getElementById('hr-code').innerText = currentPeerRefCode; 
            log('HR', 'Revealed Answer');
        }

        async function submitHumanReview() {
            const s = [1,2,3,4,5].map(i=>document.getElementById(`hr-s${i}`).value); const c = document.getElementById('hr-comment').value; if(!c) return alert("è«‹å¯«è©•èª");
            await sendToGAS({ type:'PHASE_5_PEER', studentId, targetTitle:currentPeerProblemTitle, scores:s, comment:c }); 
            alert("è©•åˆ†å·²é€å‡º"); document.getElementById('human-review-container').style.display='none'; switchPhase('reflection');
        }

        // ===============================================
        // å…¶ä»–éšæ®µèˆ‡ç³»çµ±æ ¸å¿ƒ
        // ===============================================

        async function finishLearning() {
            if((Date.now()-learningStartTime)/1000 < 5) { stressScore+=20; return typeWriterMsg('ai', 'è®€å¤ªå¿«äº†ï¼è«‹å°ˆå¿ƒçœ‹å®Œå½±ç‰‡ã€‚'); }
            if(ytPlayer && ytPlayer.pauseVideo) ytPlayer.pauseVideo();
            await sendToGAS({ type: 'PHASE_1_LEARNING', studentId, readingTime: readSeconds });
            log('LN',`å®Œæˆ - é–±è®€æ™‚é•·: ${readSeconds}s`); 
            switchPhase('exercise');
        }

        async function finishPosing() {
            const t = document.getElementById('pp-title').value; const c = document.getElementById('code-editor').value;
            if(!t) return alert("è«‹å¡«å¯«é¡Œç›®");
            sessionData.probTitle = t; sessionData.probDesc = document.getElementById('pp-desc').value; sessionData.probCode = c;
            await sendToGAS({ type: 'PHASE_3_POSING', studentId, probTitle: t, probDesc: sessionData.probDesc, probCode: c });
            log('PP','æš«å­˜ä¸¦ä¸Šå‚³'); 
            switchPhase('ai-review'); 
        }

        async function triggerAIReview() {
            document.getElementById('ai-result').style.display='block'; document.getElementById('ai-comment-cell').innerText = "AI æ•™æˆæ­£åœ¨åš´æ ¼å¯©æŸ¥...";
            const prompt = `${PROMPT_STRICT_GRADING} é¡Œç›®ï¼š${sessionData.probTitle} æ•˜è¿°ï¼š${sessionData.probDesc} ä»£ç¢¼ï¼š${sessionData.probCode} è«‹å›å‚³ JSON: { "scores":[åˆ†1,åˆ†2,åˆ†3,åˆ†4,åˆ†5], "comment":"åš´æ ¼è©•èª" }ã€‚`;
            try { 
                const r = await callGemini(prompt, "You are a JSON generator."); const json = JSON.parse(extractJSON(r)); 
                sessionData.aiScores = json.scores; sessionData.aiComment = json.comment;
                await sendToGAS({ type: 'PHASE_4_AI', studentId, probTitle: sessionData.probTitle, aiScores: json.scores, aiComment: json.comment });
                for(let i=0; i<5; i++) document.getElementById(`ai-s${i+1}`).innerText = json.scores[i]; 
                document.getElementById('ai-comment-cell').innerText = ""; typeWriterText(document.getElementById('ai-comment-cell'), json.comment); 
            } catch(e) { document.getElementById('ai-comment-cell').innerText = "AI è§£æéŒ¯èª¤"; }
        }

        async function submitAll() {
            const r = document.getElementById('rf-content').value; if(!r) return alert("è«‹å¯«åæ€"); sessionData.reflection = r;
            await sendToGAS({ type:'PHASE_6_REFLECTION', studentId, reflection: r });
            alert("å…¨èª²ç¨‹å®Œæˆï¼è³‡æ–™å·²ä¸Šå‚³æˆåŠŸï¼");
        }

        async function sendMaterialQuestion() {
            const input = document.getElementById('material-question'); const q = input.value; if(!q) return;
            log('ACT', `ASK_QA: ${q}`); 
            const aiPrompt = `[ç³»çµ±ç’°å¢ƒ] æ•™æé‡é»ï¼š${LESSON_CONFIG.summary}\nç¯„ä¾‹ä»£ç¢¼ï¼š${LESSON_CONFIG.code}\n[å­¸ç”Ÿæå•]ï¼š${q}`;
            const box = document.getElementById('chat-msgs'); const div = document.createElement('div'); div.className="msg user"; div.innerText=`[æ•™ææå•] ${q}`; box.appendChild(div); box.scrollTop=box.scrollHeight;
            const r = await callGeminiWithHistory(aiPrompt, "ä½ æ˜¯ä¸€å€‹ Python åŠ©æ•™ï¼Œè«‹å›ç­”å­¸ç”Ÿçš„å•é¡Œã€‚"); typeWriterMsg('ai', r); input.value = ""; 
        }

        function loginSystem() {
            const id = document.getElementById('student-id-input').value.trim();
            if(!id) return alert("è«‹è¼¸å…¥å­¸è™Ÿ");
            studentId = id; document.getElementById('display-student-id').innerText = "å­¸è™Ÿ: " + id; document.getElementById('login-overlay').style.display = 'none'; init();
        }

        async function init() {
            log('SYS', 'ç³»çµ±å•Ÿå‹•');
            const MODEL_URL = 'https://justadudewhohacks.github.io/face-api.js/models';
            try { await Promise.all([faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL), faceapi.nets.faceExpressionNet.loadFromUri(MODEL_URL)]); isFaceLoaded = true; } catch(e) { log('ERR', 'FaceAPI è¼‰å…¥å¤±æ•—'); }
            const video = document.getElementById('video');
            try { const stream = await navigator.mediaDevices.getUserMedia({ video: {} }); video.srcObject = stream; video.addEventListener('play', () => setInterval(monitorLoop, 1000)); } catch(e) { log('ERR', 'Camera è¼‰å…¥å¤±æ•—'); }
            try { pyodide = await loadPyodide(); log('SYS','Python Ready'); } catch(e){ log('ERR','Python Fail'); }
            document.addEventListener('mousemove', (e) => { if(lastMouseX !== 0) mouseDist += Math.sqrt(Math.pow(e.clientX - lastMouseX, 2) + Math.pow(e.clientY - lastMouseY, 2)); lastMouseX = e.clientX; lastMouseY = e.clientY; });
            document.addEventListener('keydown', (e) => { if(e.key === 'Backspace') backspaceCount++; });
            setInterval(() => { tabSwitchCount = 0; }, 5000); 
            typeWriterMsg('ai', `ä½ å¥½ï¼Œæˆ‘æ˜¯ä½ çš„ AI åŠ©æ•™ã€‚è«‹è§€çœ‹å½±ç‰‡ï¼Œæœ‰ä¸æ‡‚çš„åœ°æ–¹å¯ä»¥ç›´æ¥åœ¨æ•™æä¸‹æ–¹æå•ã€‚`);
            learningStartTime = Date.now(); startReadTimer(); 
        }

        async function monitorLoop() {
            if(isPaused) return;
            let emoDelta = 0, actDelta = 0, status = "æ­£å¸¸", statusClass = "val";
            if(isFaceLoaded) {
                const video = document.getElementById('video');
                const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions()).withFaceExpressions();
                if(detections.length > 0) {
                    faceMissingDuration = 0; document.getElementById('face-lock-overlay').style.display = 'none';
                    const ex = detections[0].expressions; const top = Object.entries(ex).sort((a,b) => b[1]-a[1])[0][0];
                    document.getElementById('emo-val').innerText = top;
                    if (top !== lastEmotion) { log('EM', `Emotion: ${top}`); lastEmotion = top; }
                    if(['sad', 'angry', 'fearful'].includes(top)) emoDelta += 5;
                } else {
                    faceMissingDuration++; document.getElementById('emo-val').innerText = "è¨Šè™Ÿéºå¤±";
                    if(faceMissingDuration > 3) document.getElementById('face-lock-overlay').style.display = 'flex';
                }
            }
            if(mouseDist > 4000) { actDelta += 10; status = "æ»‘é¼ ç„¦æ…®"; statusClass = "val bad"; log('ACT', `Mouse Jitter`); }
            else if(backspaceCount > 10) { actDelta += 10; status = "éµç›¤ç„¦æ…®"; statusClass = "val bad"; log('ACT', `Keyboard Rage`); }
            else if(tabSwitchCount > 4) { actDelta += 10; status = "é »ç¹åˆ‡æ›"; statusClass = "val warn"; log('ACT', 'Frequent Tab Switching'); }
            mouseDist = 0; backspaceCount = 0;
            document.getElementById('act-val').innerText = status; document.getElementById('act-val').className = statusClass;
            let totalDelta = emoDelta + actDelta;
            if(totalDelta > 0) stressScore += totalDelta; else stressScore = Math.max(0, stressScore - 2);
            updateStressBar();
        }

        function updateStressBar() {
            stressScore = Math.min(100, stressScore);
            const bar = document.getElementById('stress-bar'); bar.style.width = stressScore + "%";
            if(stressScore > 85) { bar.style.background = "red"; triggerTherapy(); } else if(stressScore > 50) bar.style.background = "orange"; else bar.style.background = "#00ff9d";
        }

        async function runPython() {
            const code = document.getElementById('code-editor').value;
            const outputBox = document.getElementById('output');
            outputBox.innerText = ">>> Executing...\n";
            if (!pyodide) { outputBox.innerText += "Python loading...\n"; return; }
            try { pyodide.setStdout({ batched: (msg) => { outputBox.innerText += msg + "\n"; } }); await pyodide.runPythonAsync(code); } catch (err) { outputBox.innerText += "Error:\n" + err; }
        }

        async function sendChat() {
            const v = document.getElementById('chat-input').value; if(!v) return;
            const box = document.getElementById('chat-msgs'); const div = document.createElement('div'); div.className="msg user"; div.innerText=v; box.appendChild(div); box.scrollTop=box.scrollHeight;
            document.getElementById('chat-input').value=""; log('CHAT', 'Interaction'); 
            const context = { phase: currentPhase, stress: stressScore, currentCode: document.getElementById('code-editor').value || "(ç„¡ä»£ç¢¼)", currentProb: document.getElementById('pp-title').value || "(ç„¡é¡Œç›®)" };
            const dynamicPrompt = `[System Instruction] ä½ æ˜¯Code Nexuså°å¸«ã€‚éšæ®µ:${context.phase} å£“åŠ›:${context.stress}% ä»£ç¢¼:${context.currentCode} é¡Œç›®:${context.currentProb}`;
            const r = await callGeminiWithHistory(v, dynamicPrompt);
            typeWriterMsg('ai', r); chatHistory.push({ role: "user", parts: [{ text: v }] }); chatHistory.push({ role: "model", parts: [{ text: r }] }); if (chatHistory.length > 20) chatHistory = chatHistory.slice(chatHistory.length - 20); sendToGAS({ type: 'CHAT_LOG', studentId, userMsg: v, aiMsg: r });
        }

        async function callGeminiWithHistory(userText, sysPrompt) {
            if(!GAS_URL.startsWith("http")) return "API URL Error";
            const combinedMsg = sysPrompt + "\n\n[å­¸ç”Ÿèªª]ï¼š" + userText;
            const messages = [...chatHistory, { role: "user", parts: [{ text: combinedMsg }] }];
            try { const res = await fetch(GAS_URL, { method: 'POST', mode: 'cors', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify({ type: 'CALL_GEMINI_CHAT', messages: messages }) }); const json = await res.json(); if (json.status === 'error') return "ç³»çµ±éŒ¯èª¤: " + json.message; return json.text || "AI æ€è€ƒä¸­..."; } catch(e) { return "é€£ç·šéŒ¯èª¤"; }
        }

        async function callGemini(userText, systemPrompt) {
            if(!GAS_URL.startsWith("http")) return "API URL Error";
            const fullPrompt = systemPrompt + "\n\n" + userText;
            try { const res = await fetch(GAS_URL, { method: 'POST', mode: 'cors', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify({ type: 'CALL_GEMINI', prompt: fullPrompt }) }); const json = await res.json(); return json.text || "Error"; } catch(e) { return "Error"; }
        }

        async function triggerTherapy() {
            if(isPaused) return; isPaused = true; document.getElementById('therapy-overlay').style.display='flex'; if (ytPlayer && ytPlayer.pauseVideo) ytPlayer.pauseVideo();
            const r = await callGemini("Alert", PROMPT_THERAPY_STYLE);
            const txt = document.getElementById('therapy-text'); txt.innerText = ""; let i = 0; const t = setInterval(()=>{ txt.innerText += r.charAt(i++); if(i>=r.length) { clearInterval(t); document.getElementById('btn-resume').style.opacity='1'; } }, 30);
        }

        function switchPhase(phase) {
            tabSwitchCount++; currentPhase = phase;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); document.querySelectorAll('.content-area').forEach(c => c.classList.remove('active'));
            const list = ['learning', 'exercise', 'posing', 'ai-review', 'human-review', 'reflection'];
            const idx = list.indexOf(phase);
            document.querySelectorAll('.tab-btn')[idx].classList.add('active'); document.querySelectorAll('.content-area')[idx].classList.add('active'); log('NAV', phase);
        }

        function typeWriterMsg(role, text) {
            const box = document.getElementById('chat-msgs'); const div = document.createElement('div'); div.className = `msg ${role} typing-cursor`; box.appendChild(div);
            let i = 0; let currentText = ""; const t = setInterval(()=>{ currentText += text.charAt(i++); div.innerHTML = marked.parse(currentText); box.scrollTop = box.scrollHeight; if(i>=text.length){ clearInterval(t); div.classList.remove('typing-cursor'); } }, 20);
        }
        function typeWriterText(el, text) { let i = 0; let currentText = ""; const t = setInterval(()=>{ currentText += text.charAt(i++); el.innerHTML = marked.parse(currentText); if(i>=text.length) clearInterval(t); }, 15); }
        function extractJSON(str) { const s = str.indexOf('{'); const e = str.lastIndexOf('}'); return (s!==-1 && e!==-1) ? str.substring(s, e+1) : "{}"; }
        async function sendToGAS(pl) { if(!GAS_URL.startsWith("http")) return; await fetch(GAS_URL, { method:'POST', mode:'no-cors', headers:{'Content-Type':'application/json'}, body:JSON.stringify(pl) }); }
        function log(type, detail) { const box = document.getElementById('log-box'); const div = document.createElement('div'); div.className='log-entry'; div.innerText=`[${new Date().toLocaleTimeString()}] ${type}: ${detail}`; box.appendChild(div); box.scrollTop=box.scrollHeight; if(type !== 'ACT' && type !== 'CHAT') sendToGAS({ type:'LOG', studentId, action:type, detail }); }
        function stopTherapy() { document.getElementById('therapy-overlay').style.display='none'; stressScore=40; isPaused=false; }
    </script>
</body>
</html>
