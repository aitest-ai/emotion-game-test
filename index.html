<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Code Nexus v9.0: ç¤¾ç¾¤äº’è©•èˆ‡çœŸå¯¦äº’å‹•ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        :root {
            --bg-color: #050505; --panel-bg: #101010; --accent: #00ff9d; --accent-dim: #005533;
            --danger: #ff3333; --warning: #ffcc00; --text: #e0e0e0; --border: #333;
        }
        body { background: var(--bg-color); color: var(--text); font-family: 'Microsoft JhengHei', sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* å·¦å´èˆ‡åŸºç¤æ¨£å¼ */
        .panel-left { width: 320px; background: var(--panel-bg); border-right: 1px solid var(--border); padding: 15px; display: flex; flex-direction: column; height: 100vh; box-sizing: border-box; }
        .header { text-align: center; color: var(--accent); margin-bottom: 10px; font-weight: bold; letter-spacing: 1px;}
        .student-info { text-align: center; color: #888; font-size: 0.8em; margin-bottom: 10px; border-bottom: 1px solid #333; padding-bottom: 5px;}
        .cam-box { flex: 0 0 200px; background: #000; border: 2px solid var(--accent); border-radius: 6px; overflow: hidden; position: relative; margin-bottom: 10px; }
        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        .status-box { flex: 0 0 auto; background: #1a1a1a; padding: 10px; margin-bottom: 10px; border-radius: 6px; border: 1px solid #333; font-size: 0.9em; }
        .metric-row { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .val { font-weight: bold; color: var(--accent); }
        .stress-bar-bg { height: 6px; background: #333; border-radius: 3px; margin-top: 5px; overflow: hidden; }
        .stress-bar { height: 100%; width: 0%; background: var(--accent); transition: width 0.5s; }
        #log-box { flex: 1 1 auto; background: #000; padding: 5px; font-family: monospace; font-size: 0.75em; color: #888; overflow-y: auto; border: 1px solid #333; min-height: 100px; }
        .log-entry { margin-bottom: 2px; border-bottom: 1px solid #222; padding-bottom: 2px; }

        /* å³å´é¢æ¿ */
        .panel-right { flex-grow: 1; padding: 20px; display: flex; flex-direction: column; position: relative; overflow-y: auto; }
        .nav-tabs { display: flex; gap: 10px; margin-bottom: 15px; flex: 0 0 auto;}
        .tab-btn { background: #222; border: 1px solid #444; color: #aaa; padding: 8px 15px; cursor: pointer; border-radius: 4px; transition: 0.3s; }
        .tab-btn.active { background: var(--accent-dim); color: white; border-color: var(--accent); }
        .content-area { display: none; flex-direction: column; flex-grow: 1; animation: fadeIn 0.5s; }
        .content-area.active { display: flex; }
        @keyframes fadeIn { from{opacity:0;} to{opacity:1;} }

        input, textarea, select { width: 100%; background: #1a1a1a; border: 1px solid #333; color: white; padding: 10px; border-radius: 4px; box-sizing: border-box; margin-bottom: 10px; }
        textarea { resize: vertical; font-family: monospace; }
        .editor-container { flex-grow: 1; display: flex; flex-direction: column; min-height: 300px; border: 1px solid #333; border-radius: 6px; overflow: hidden; }
        #code-editor { flex-grow: 1; background: #0c0c0c; color: #ddd; padding: 15px; border:none; outline:none; font-family: 'Consolas', monospace; font-size:14px; }
        .btn-action { background: var(--accent-dim); color: white; border: 1px solid var(--accent); padding: 8px 20px; cursor: pointer; border-radius: 4px; }
        .btn-action:hover { background: var(--accent); color: black; }
        #output { height: 100px; background: #000; color: #aaa; padding: 10px; font-family: monospace; border-top: 1px solid #333; overflow-y: auto; white-space: pre-wrap; }

        .score-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .score-table td, .score-table th { border: 1px solid #333; padding: 8px; text-align: center; }
        .score-table th { background: #222; color: var(--accent); }

        /* èŠå¤©å®¤ */
        #chat-panel { height: 180px; border-top: 1px solid #333; background: #080808; display: flex; flex-direction: column; padding: 10px; margin-top: 10px; flex: 0 0 auto; }
        #chat-msgs { flex-grow: 1; overflow-y: auto; margin-bottom: 10px; }
        .msg { padding: 8px 12px; margin-bottom: 5px; border-radius: 4px; font-size: 0.9em; max-width: 90%; }
        /* æ‰“å­—æ©Ÿæ•ˆæœçš„å…‰æ¨™ */
        .typing-cursor::after { content: 'â–‹'; animation: blink 1s infinite; color: var(--accent); }
        @keyframes blink { 0%, 100% {opacity: 1;} 50% {opacity: 0;} }
        
        .msg.ai { color: var(--accent); background: #112211; border-left: 3px solid var(--accent); align-self: flex-start; }
        .msg.user { color: #fff; background: #004455; align-self: flex-end; }

        /* è¦†è“‹å±¤ */
        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(5,5,5,0.95); z-index: 1000; display: none; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        
        /* åš´æ ¼çš„åå§¿é–å®š */
        #face-lock-overlay { 
            backdrop-filter: blur(10px); background: rgba(0,0,0,0.85); z-index: 3000;
        }
        .lock-icon { font-size: 50px; margin-bottom: 20px; animation: pulse 1s infinite; }

        #login-overlay { display: flex; z-index: 4000; background: #000; }
        .login-box { width: 350px; padding: 40px; border: 1px solid var(--accent); border-radius: 10px; background: #111; }
        
    </style>
</head>
<body>

    <!-- 1. ç™»å…¥å±¤ -->
    <div id="login-overlay" class="overlay">
        <div class="login-box">
            <h2 style="color:var(--accent);">CODE NEXUS v9.0</h2>
            <p style="color:#888;">è«‹è¼¸å…¥å­¸è™Ÿå•Ÿå‹•ç³»çµ±</p>
            <input type="text" id="student-id-input" placeholder="å­¸è™Ÿ" style="text-align:center;">
            <button class="btn-action" onclick="loginSystem()" style="width:100%;">å•Ÿå‹• â–¶</button>
        </div>
    </div>

    <!-- 2. åš´æ ¼çš„è‡‰éƒ¨é–å®šå±¤ (Requirement 3) -->
    <div id="face-lock-overlay" class="overlay">
        <div class="lock-icon">âš ï¸</div>
        <h2 style="color:var(--warning);">ç³»çµ±å·²æš«åœ</h2>
        <p style="color:#ccc; max-width:400px; line-height:1.5;">
            åµæ¸¬ä¸åˆ°æ‚¨çš„è‡‰éƒ¨ã€‚ç‚ºäº†ç¢ºä¿å­¸ç¿’å“è³ªï¼Œ<br>è«‹å›åˆ°åº§ä½ä¸Šä¸¦åæ­£ï¼Œç³»çµ±å°‡è‡ªå‹•è§£é–ã€‚
        </p>
    </div>

    <!-- 3. æ²»ç™‚æ¨¡å¼å±¤ -->
    <div id="therapy-overlay" class="overlay">
        <h2 style="color:var(--danger)">âš ï¸ å£“åŠ›éè¼‰</h2>
        <p>ç³»çµ±åµæ¸¬åˆ°éåº¦åˆ‡æ›æˆ–è² é¢æƒ…ç·’ã€‚è«‹ç¨ä½œä¼‘æ¯ã€‚</p>
        <div id="therapy-text" style="color:#fff; margin:20px 0; font-size:1.2em;">è¼‰å…¥ä¸­...</div>
        <button class="btn-action" id="btn-resume" onclick="stopTherapy()" style="opacity:0;">ç¹¼çºŒä»»å‹™</button>
    </div>

    <!-- å·¦å´é¢æ¿ -->
    <div class="panel-left">
        <div class="header">NEXUS v9.0</div>
        <div id="display-student-id" class="student-info">æœªç™»å…¥</div>
        
        <div class="cam-box"><video id="video" autoplay muted playsinline></video></div>
        
        <div class="status-box">
            <div class="metric-row"><span>æƒ…ç·’:</span> <span id="emo-val" class="val">--</span></div>
            <div class="metric-row"><span>ç‹€æ…‹:</span> <span id="act-val" class="val" style="color:gray">æ­£å¸¸</span></div>
            <div style="margin-top:5px; font-size:0.8em; color:gray;">å­¸ç¿’å£“åŠ› (Stress Level)</div>
            <div class="stress-bar-bg"><div id="stress-bar" class="stress-bar"></div></div>
        </div>
        
        <div class="log-header">ç³»çµ±æ—¥èªŒ</div>
        <div id="log-box"></div>
    </div>

    <!-- å³å´é¢æ¿ -->
    <div class="panel-right">
        <!-- åˆ†é æ¨™ç±¤ -->
        <div class="nav-tabs">
            <button class="tab-btn active" onclick="switchPhase('learning')">1. å­¸ç¿’ (LN)</button>
            <button class="tab-btn" onclick="switchPhase('posing')">2. æ“¬é¡Œ (PP)</button>
            <button class="tab-btn" onclick="switchPhase('human-review')">3. è©•åŒå„• (HR)</button>
            <button class="tab-btn" onclick="switchPhase('ai-review')">4. AI è©•æˆ‘ (PA)</button>
            <button class="tab-btn" onclick="switchPhase('reflection')">5. åæ€ (RF)</button>
        </div>

        <!-- 1. å­¸ç¿’ -->
        <div id="phase-learning" class="content-area active">
            <div style="background:#151515; padding:20px; border-radius:8px; border-left:4px solid var(--accent);">
                <h2>ğŸ“ å–®å…ƒï¼šPython æ¢ä»¶åˆ¤æ–·</h2>
                <p>è«‹é–±è®€æ•™æ (è«‹å‹¿å¿«é€Ÿè·³éï¼Œä»¥å…å¢åŠ å£“åŠ›å€¼)</p>
                <pre style="background:#222; padding:10px;">if score >= 60: print("Pass")</pre>
                <button class="btn-action" onclick="finishLearning()">âœ… é–±è®€å®Œç•¢</button>
            </div>
        </div>

        <!-- 2. æ“¬é¡Œ -->
        <div id="phase-posing" class="content-area">
            <label>é¡Œç›®åç¨±</label><input id="pp-title" placeholder="é¡Œç›®...">
            <label>é¡Œç›®æ•˜è¿°</label><textarea id="pp-desc" style="height:80px;"></textarea>
            <label>åƒè€ƒä»£ç¢¼</label><textarea id="pp-code" style="height:100px; font-family:monospace;"></textarea>
            <button class="btn-action" onclick="finishPosing()">æš«å­˜é¡Œç›®ï¼Œé€²å…¥è©•åŒå„• â¡</button>
        </div>

        <!-- 3. äººé¡åŒå„•äº’è©• (æ–°åŠŸèƒ½) -->
        <div id="phase-human-review" class="content-area">
            <h3>ğŸ‘¥ è©•åˆ†å…¶ä»–åŒå­¸çš„é¡Œç›®</h3>
            <p>è«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•ï¼Œå¾é›²ç«¯é¡Œåº«è¼‰å…¥ä¸€é¡Œå…¶ä»–åŒå­¸å‡ºçš„é¡Œç›®ã€‚</p>
            <button class="btn-action" onclick="loadPeerProblem()" style="background:#444;">ğŸ“¥ è¼‰å…¥æŒ‘æˆ°</button>
            
            <div id="human-review-area" style="display:none; margin-top:20px; border:1px solid #333; padding:15px; border-radius:6px;">
                <h4 id="hr-title" style="color:var(--accent);">é¡Œç›®è¼‰å…¥ä¸­...</h4>
                <p id="hr-desc" style="color:#aaa;"></p>
                <pre id="hr-code" style="background:#222; padding:10px;"></pre>
                
                <hr style="border-color:#333; margin:15px 0;">
                
                <label>è«‹çµ¦äºˆè©•åˆ† (1-5)</label>
                <div style="display:flex; gap:5px; margin-bottom:10px;">
                   <input id="hr-score-1" type="number" min="1" max="5" placeholder="é¡Œç›®æ­£ç¢ºæ€§">
                   <input id="hr-score-2" type="number" min="1" max="5" placeholder="è¤‡é›œåº¦">
                   <input id="hr-score-3" type="number" min="1" max="5" placeholder="å¯¦ç”¨æ€§">
                   <input id="hr-score-4" type="number" min="1" max="5" placeholder="ä»£ç¢¼æ­£ç¢º">
                   <input id="hr-score-5" type="number" min="1" max="5" placeholder="å¯è®€æ€§">
                </div>
                <label>çµ¦åŒå­¸çš„è©•èª</label>
                <textarea id="hr-comment" placeholder="å¯«é»é¼“å‹µæˆ–å»ºè­°..."></textarea>
                
                <button class="btn-action" onclick="submitHumanReview()">ğŸ“¤ é€å‡ºè©•åˆ†</button>
            </div>
        </div>

        <!-- 4. AI è©•åˆ† (è©•è‡ªå·±) -->
        <div id="phase-ai-review" class="content-area">
            <h3>ğŸ¤– AI è©•åˆ†ä½ çš„é¡Œç›®</h3>
            <button class="btn-action" onclick="triggerAIReview()">å•Ÿå‹• AI è©•åˆ†</button>
            <div id="ai-result" style="display:none; margin-top:10px;">
                <div id="ai-comment-box" style="white-space:pre-wrap; color:#ddd;"></div>
            </div>
        </div>

        <!-- 5. åæ€ -->
        <div id="phase-reflection" class="content-area">
            <h3>ğŸ¤” å­¸ç¿’åæ€</h3>
            <textarea id="rf-content" style="height:150px;" placeholder="åæ€..."></textarea>
            <button class="btn-action" onclick="submitAll()">âœ… æäº¤æœ¬å–®å…ƒæ‰€æœ‰æˆæœ</button>
        </div>

        <!-- èŠå¤©å®¤ -->
        <div id="chat-panel">
            <div id="chat-msgs"></div>
            <div style="display:flex; gap:10px;">
                <input id="chat-input" placeholder="è¼¸å…¥è¨Šæ¯..." onkeypress="if(event.key==='Enter') sendChat()">
                <button class="btn-action" onclick="sendChat()">ç™¼é€</button>
            </div>
        </div>
    </div>

    <script>
        // ================= CONFIG =================
        const API_KEY = "AIzaSyBkm9yIrb-DKXGUgfrFa5wCJKcm4TqQ1Tw";
        const GAS_URL = "https://script.google.com/macros/s/AKfycbywnbTtbBRjt_njPJdjXIS_xu8l14q8kdw7vJ6GKYURk3kEiNzcMEzmLDiswZU-VmXg3A/exec"; 
        // ==========================================

        let studentId = "";
        let currentPhase = 'learning';
        let isFaceLoaded = false;
        let isPaused = false;
        
        // æš«å­˜è³‡æ–™
        let sessionData = { probTitle:"", probDesc:"", probCode:"", aiScores:[], aiComment:"", reflection:"" };
        let currentPeerProblemTitle = ""; // ç´€éŒ„æ­£åœ¨è©•èª°çš„é¡Œç›®

        // å£“åŠ›ç›£æ¸¬è®Šæ•¸ (Requirement 2)
        let stressScore = 0;
        let tabSwitchCount = 0; // åˆ†é åˆ‡æ›æ¬¡æ•¸
        let tabSwitchTimer = null;
        let learningStartTime = 0; // é–±è®€é–‹å§‹æ™‚é–“
        let faceMissingDuration = 0; // è‡‰éƒ¨æ¶ˆå¤±æ™‚é–“

        // åˆå§‹åŒ–
        function loginSystem() {
            const id = document.getElementById('student-id-input').value.trim();
            if(!id) return alert("è«‹è¼¸å…¥å­¸è™Ÿ");
            studentId = id;
            document.getElementById('display-student-id').innerText = "å­¸è™Ÿ: " + id;
            document.getElementById('login-overlay').style.display = 'none';
            init();
        }

        async function init() {
            log('SYS', 'ç³»çµ±å•Ÿå‹•');
            // Face API
            const MODEL_URL = 'https://justadudewhohacks.github.io/face-api.js/models';
            await Promise.all([
                faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                faceapi.nets.faceExpressionNet.loadFromUri(MODEL_URL)
            ]);
            isFaceLoaded = true;
            
            // Webcam
            const video = document.getElementById('video');
            const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
            video.srcObject = stream;
            video.addEventListener('play', () => setInterval(monitorLoop, 1000));
            
            // Tab Switch Reset Timer (æ¯5ç§’é‡ç½®è¨ˆæ•¸)
            setInterval(() => { tabSwitchCount = 0; }, 5000);

            typeWriterMsg('ai', `ä½ å¥½ï¼Œæˆ‘æ˜¯ä½ çš„ AI å¤¥ä¼´ã€‚ç¾åœ¨æ˜¯å­¸ç¿’éšæ®µï¼Œè«‹å°ˆå¿ƒé–±è®€ã€‚`);
            learningStartTime = Date.now();
        }

        // ================= æ ¸å¿ƒç›£æ§ (Requirement 2 & 3) =================
        async function monitorLoop() {
            if(isPaused) return;

            // 1. è‡‰éƒ¨èˆ‡æƒ…ç·’åµæ¸¬
            const video = document.getElementById('video');
            let hasFaceNow = false;
            let emoPenalty = 0;

            if(isFaceLoaded) {
                const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions()).withFaceExpressions();
                
                if(detections.length > 0) {
                    hasFaceNow = true;
                    faceMissingDuration = 0;
                    document.getElementById('face-lock-overlay').style.display = 'none'; // è§£é–
                    
                    const ex = detections[0].expressions;
                    const top = Object.entries(ex).sort((a,b) => b[1]-a[1])[0][0];
                    document.getElementById('emo-val').innerText = top;

                    // è² é¢æƒ…ç·’ç´å…¥å£“åŠ› (Requirement 2)
                    if(['sad', 'angry', 'fearful'].includes(top)) emoPenalty += 5;
                
                } else {
                    // è‡‰ä¸è¦‹äº†
                    faceMissingDuration++;
                    document.getElementById('emo-val').innerText = "è¨Šè™Ÿéºå¤±";
                    
                    // æ¶ˆå¤±è¶…é 3 ç§’ -> å¼·åˆ¶é–å®š (Requirement 3)
                    if(faceMissingDuration > 3) {
                        document.getElementById('face-lock-overlay').style.display = 'flex';
                    }
                }
            }

            // 2. è¡Œç‚ºå£“åŠ›è¨ˆç®— (Tab Switching + Emotion)
            let behaviorPenalty = 0;
            let statusText = "æ­£å¸¸";
            let statusClass = "val";

            // éå‹•åµæ¸¬ï¼š5ç§’å…§åˆ‡æ›è¶…é3æ¬¡åˆ†é 
            if(tabSwitchCount > 3) {
                behaviorPenalty += 10;
                statusText = "åˆ†å¿ƒ/ç„¦æ…®";
                statusClass = "val warn";
                log('ACT', 'é »ç¹åˆ‡æ›åˆ†é ');
            }

            document.getElementById('act-val').innerText = statusText;
            document.getElementById('act-val').className = statusClass;

            // ç¸½å£“åŠ›è¨ˆç®—
            // åŸºç¤å£“åŠ›(æœƒè¡°é€€) + æƒ…ç·’å£“åŠ› + è¡Œç‚ºå£“åŠ›
            let currentDelta = emoPenalty + behaviorPenalty;
            if(currentDelta > 0) stressScore += currentDelta;
            else stressScore = Math.max(0, stressScore - 2); // è‡ªç„¶æ”¾é¬†

            updateStressBar();
        }

        function updateStressBar() {
            stressScore = Math.min(100, stressScore);
            const bar = document.getElementById('stress-bar');
            bar.style.width = stressScore + "%";
            
            if(stressScore < 50) bar.style.background = "#00ff9d";
            else if(stressScore < 85) bar.style.background = "orange";
            else {
                bar.style.background = "red";
                triggerTherapy(); // å£“åŠ›çˆ†è¡¨
            }
        }

        // ================= åŠŸèƒ½é‚è¼¯ =================

        function switchPhase(phase) {
            // ç´€éŒ„åˆ†é åˆ‡æ› (Requirement 2)
            tabSwitchCount++;
            monitorLoop(); // ç«‹å³æª¢æŸ¥å£“åŠ›

            currentPhase = phase;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.content-area').forEach(c => c.classList.remove('active'));
            
            // Find index manually or use specific ID logic
            const phases = ['learning', 'posing', 'human-review', 'ai-review', 'reflection'];
            const idx = phases.indexOf(phase);
            if(idx >= 0) {
                document.querySelectorAll('.tab-btn')[idx].classList.add('active');
                document.querySelectorAll('.content-area')[idx].classList.add('active');
            }
            log('NAV', `é€²å…¥éšæ®µ: ${phase}`);
        }

        function finishLearning() {
            // é€Ÿè®€åµæ¸¬ (Requirement 2)
            const duration = (Date.now() - learningStartTime) / 1000;
            if(duration < 10) {
                stressScore += 20; // æ‡²ç½°
                typeWriterMsg('ai', 'ä½ è®€å¾—å¤ªå¿«äº†ï¼Œé€™æ¨£å¾ˆé›£å¸æ”¶å–”ã€‚(å£“åŠ›å€¼ä¸Šå‡)');
                log('ACT', `é€Ÿè®€ (${duration}s)`);
            } else {
                log('LN', 'é–±è®€å®Œæˆ');
                switchPhase('posing');
            }
        }

        function finishPosing() {
            const t = document.getElementById('pp-title').value;
            const d = document.getElementById('pp-desc').value;
            const c = document.getElementById('pp-code').value;
            if(!t || !c) return alert("è«‹å¡«å¯«å®Œæ•´");
            
            sessionData.probTitle = t;
            sessionData.probDesc = d;
            sessionData.probCode = c;
            
            log('PP', 'é¡Œç›®æš«å­˜');
            switchPhase('human-review');
        }

        // --- äººé¡åŒå„•äº’è©• (Requirement 4) ---
        async function loadPeerProblem() {
            const btn = document.querySelector('#phase-human-review button');
            btn.innerText = "é€£ç·šé¡Œåº«ä¸­...";
            btn.disabled = true;

            // å‘¼å« GAS doGet
            try {
                const res = await fetch(`${GAS_URL}?studentId=${studentId}`);
                const json = await res.json();
                
                if(json.status === 'success') {
                    const p = json.problem;
                    document.getElementById('hr-title').innerText = p.title;
                    document.getElementById('hr-desc').innerText = p.desc;
                    document.getElementById('hr-code').innerText = p.code;
                    
                    currentPeerProblemTitle = p.title;
                    document.getElementById('human-review-area').style.display = 'block';
                    log('HR', `è¼‰å…¥é¡Œç›®: ${p.title}`);
                } else {
                    alert(json.message || "è¼‰å…¥å¤±æ•—");
                }
            } catch(e) {
                console.error(e);
                alert("ç„¡æ³•é€£ç·šè‡³é›²ç«¯é¡Œåº«ï¼Œå¯èƒ½æ˜¯ç¬¬ä¸€æ¬¡ä½¿ç”¨é‚„æ²’æœ‰è³‡æ–™ã€‚");
            }
            btn.innerText = "ğŸ“¥ è¼‰å…¥æŒ‘æˆ°";
            btn.disabled = false;
        }

        async function submitHumanReview() {
            const scores = [
                document.getElementById('hr-score-1').value,
                document.getElementById('hr-score-2').value,
                document.getElementById('hr-score-3').value,
                document.getElementById('hr-score-4').value,
                document.getElementById('hr-score-5').value
            ];
            const comment = document.getElementById('hr-comment').value;

            if(scores.some(s => !s) || !comment) return alert("è«‹å¡«å¯«å®Œæ•´è©•åˆ†");

            const payload = {
                type: 'HUMAN_REVIEW',
                studentId: studentId,
                targetTitle: currentPeerProblemTitle,
                scores: scores,
                comment: comment
            };

            await sendToGAS(payload);
            alert("è©•åˆ†å·²é€å‡ºï¼æ„Ÿè¬ä½ çš„è²¢ç»ã€‚");
            document.getElementById('human-review-area').style.display = 'none';
            switchPhase('ai-review');
        }

        // --- AI è©•åˆ† (Requirement 1: Type Effect) ---
        async function triggerAIReview() {
            document.getElementById('ai-result').style.display = 'block';
            const box = document.getElementById('ai-comment-box');
            box.innerText = "AI æ­£åœ¨åˆ†æä½ çš„ä»£ç¢¼...";
            
            // æ¨¡æ“¬ AI æ€è€ƒ
            const prompt = `è©•åˆ†é¡Œç›®:${sessionData.probTitle}, ä»£ç¢¼:${sessionData.probCode}ã€‚è«‹çµ¦å‡ºè©³ç´°è©•èª(ç¹é«”ä¸­æ–‡)ã€‚`;
            const reply = await callGemini(prompt);
            
            // å„²å­˜çµæœ
            sessionData.aiComment = reply;
            sessionData.aiScores = [4,3,4,4,5]; // ç°¡åŒ–è™•ç†ï¼Œå¯¦éš›å¯ç”¨ JSON è§£æ
            
            // æ‰“å­—æ©Ÿæ•ˆæœé¡¯ç¤º
            box.innerText = "";
            typeWriterText(box, reply);
            
            log('PA', 'AI è©•åˆ†å®Œæˆ');
        }

        // --- æäº¤ç¸½çµ ---
        async function submitAll() {
            const rf = document.getElementById('rf-content').value;
            if(!rf) return alert("è«‹å¯«åæ€");
            sessionData.reflection = rf;
            
            await sendToGAS({ type: 'FULL_RECORD', studentId, ...sessionData });
            alert("å–®å…ƒå®Œæˆï¼è³‡æ–™å·²ä¸Šå‚³ã€‚");
        }

        // ================= å·¥å…·å‡½æ•¸ =================

        // æ‰“å­—æ©Ÿæ•ˆæœ (Requirement 1)
        function typeWriterMsg(role, text) {
            const box = document.getElementById('chat-msgs');
            const div = document.createElement('div');
            div.className = `msg ${role} typing-cursor`;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
            
            let i = 0;
            const timer = setInterval(() => {
                div.innerText += text.charAt(i);
                i++;
                if (i >= text.length) {
                    clearInterval(timer);
                    div.classList.remove('typing-cursor'); // ç§»é™¤å…‰æ¨™
                }
                box.scrollTop = box.scrollHeight; // è·Ÿéš¨æ²å‹•
            }, 30); // æ‰“å­—é€Ÿåº¦
        }

        function typeWriterText(element, text) {
             let i = 0;
             const timer = setInterval(() => {
                 element.innerText += text.charAt(i);
                 i++;
                 if (i >= text.length) clearInterval(timer);
             }, 20);
        }

        async function sendChat() {
            const val = document.getElementById('chat-input').value;
            if(!val) return;
            // é¡¯ç¤ºä½¿ç”¨è€…è¨Šæ¯ (ç„¡æ‰“å­—æ•ˆæœ)
            const box = document.getElementById('chat-msgs');
            const div = document.createElement('div');
            div.className = "msg user";
            div.innerText = val;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
            
            document.getElementById('chat-input').value = "";
            
            // AI å›æ‡‰ (æœ‰æ‰“å­—æ•ˆæœ)
            const reply = await callGemini(`ä½ æ˜¯è€å¸«ã€‚å­¸ç”Ÿèªª:${val}ã€‚ç°¡çŸ­å›æ‡‰ã€‚`);
            typeWriterMsg('ai', reply);
        }

        async function callGemini(text) {
            if(!API_KEY || API_KEY.includes("è«‹å¡«å…¥")) return "API Key æœªè¨­å®š";
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${API_KEY}`;
            try {
                const res = await fetch(url, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ contents: [{ parts: [{ text }] }] }) });
                const data = await res.json();
                return data.candidates[0].content.parts[0].text;
            } catch(e) { return "é€£ç·šéŒ¯èª¤"; }
        }

        async function sendToGAS(payload) {
            if(!GAS_URL.startsWith("http")) return;
            try {
                await fetch(GAS_URL, {
                    method: 'POST', mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
            } catch(e) { console.error(e); }
        }

        function log(type, detail) {
            const box = document.getElementById('log-box');
            const div = document.createElement('div');
            div.className = 'log-entry';
            div.innerText = `[${new Date().toLocaleTimeString()}] ${type}: ${detail}`;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
            sendToGAS({ type: 'LOG', studentId, action: type, detail });
        }

        function triggerTherapy() {
            if(isPaused) return; isPaused = true;
            document.getElementById('therapy-overlay').style.display = 'flex';
            setTimeout(() => {
                document.getElementById('therapy-text').innerText = "æ·±å‘¼å¸... 3... 2... 1...";
                document.getElementById('btn-resume').style.opacity = '1';
            }, 2000);
        }
        function stopTherapy() {
            document.getElementById('therapy-overlay').style.display = 'none';
            stressScore = 40; isPaused = false;
        }

    </script>
</body>
</html>
